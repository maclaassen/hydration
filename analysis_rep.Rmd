---
title: "Results consumption and hydration status"
author: "Almudena Claassen"
date: "December 2025"
output: 
  html_document: 
    toc: yes
    toc_float: yes
editor_options: 
  chunk_output_type: console
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 80)
```
```{r, include=FALSE, cache=FALSE}
# make sure the data is in the same folder as Rm  arkdown document
setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

library(markdown)
library(foreign)
library(plyr)
library(dplyr)
library(tidyr)
library(janitor)
library(psych)
library(lme4)
library(lmerTest)
library(ggplot2)
library(readr)
library(forcats)
library(tibble)
library(gtsummary)
library(gt)
library(DHARMa)
# devtools::install_github("MAClaassen/drygatebrewer")
library(drygatebrewer)
library(colorblindcheck) #check colorblindness friendliness of palette
library(Hmisc) #for correlation matrix
library(ggpubr) #for correlation plot
library(ggtext)
library(ggpattern)
library(patchwork)
library(ragg)
library(PupillometryR)
library(performance)
#library(rcompanion)

# library(conflicted)
# conflict_prefer("summarise", "dplyr")
# conflict_prefer("filter", "dplyr")
# conflict_prefer("mutate", "dplyr")
# conflict_prefer("arrange", "dplyr")
# conflicts_prefer(psych::describe)
```

```{r}
# functions to transform height and weight measures
feet_inches_to_cm <- 
  function(feet, inches){
    feet_to_cm <- feet * 30.48
    inches_to_cm <- inches * 2.54
    cm <- feet_to_cm + inches_to_cm
    cm <- round(cm, digits = 0)
    return(cm)
  }

stones_pounds_to_kg <-
  function(pounds, stones=NULL){
    if(missing(stones)){
      pounds_to_kg <- pounds * 0.453592
      kg <- pounds_to_kg
      kg <- round(kg, digits = 0)
      return(kg)
    }
    else{
      stones_to_kg <- stones * 6.35029
      pounds_to_kg <- pounds * 0.453592
      kg <- stones_to_kg + pounds_to_kg
      kg <- round(kg, digits = 0)
      return(kg)
    }
}

geom_plot <- 
  function(df, variable, xlab) {
    variable <- enquo(variable)
    plot <-
      ggplot(df, aes(x = !! variable)) +
      geom_bar(stat = "bin", aes(y=..density..), fill = "darkgrey", bins = 15) + xlab(xlab) +
      geom_density() + theme_bw()
  }
```
# Cleaning data

```{r}
data <- "Representative_raw.csv"
headers = read_csv(data, col_names = FALSE, n_max = 1) %>%
  as.character()
raw_data = read_csv(data, skip = 3, col_names = FALSE)
colnames(raw_data)= headers

# 1465 responses
length(unique(raw_data$ResponseId)) 

# filter out those who did not confirm: 1200 left
raw_data <- subset(raw_data, Q_consent == 1 & Finished == 1)

raw_data <- raw_data %>% clean_names()

# create exclusion and control variables
raw_data$exclude <- NA
raw_data$control <- NA

# hydration measures exclusion criteria (having the a cold/flu, cystitis, or vomiting/diarrhea)
raw_data <- raw_data %>% 
  mutate(exclude = case_when(exclusions_4 == "1" ~ 1,
                             exclusions_8 == "1" ~ 1,
                             exclusions_9 == "1" ~ 1)) 

raw_data <- raw_data %>% 
  mutate(control = case_when(exclusions_1 == "1" ~ 1,
                             exclusions_2 == "1" ~ 1,
                             exclusions_3 == "1" ~ 1,
                             exclusions_5 == "1" ~ 1,
                             exclusions_6 == "1" ~ 1,
                             exclusions_7 == "1" ~ 1,
                             exclusions_10 == "1" ~ NA_real_,
                             TRUE ~ 0)) 

# add pp number and set as first column
raw_data <- raw_data %>% 
  dplyr::mutate (pp = paste0(row_number())) %>%
  dplyr::select(pp,everything()) 

# check out possible other exclusion reasons
raw_data %>%
  filter(!is.na(exclusions_10_text)) %>% 
  select(pp, exclusions_10_text, response_id) %>% 
  DT::datatable(
  .,
  options = list(
    autoWidth = TRUE,
    scrollY = TRUE,
    scrollX = TRUE, 
    pageLength = 10
  ))

# R_D8lao1PoJ6llu7L uses medication (+ reports inconsistencies in drink consumption so exclude)

raw_data <- raw_data %>% 
  mutate(exclude = case_when(response_id == "R_D8lao1PoJ6llu7L" ~ 1, TRUE ~ exclude))

# some others that reported potential factors affecting hydration outcomes are added to control, unless related to their fluid intake
raw_data <- raw_data %>% 
  dplyr::mutate(control = case_when(!is.na(exclusions_10_text) ~ 1,
                             response_id %in% c("R_2uNXh5uzOlcfqJN", 
                                                "R_3ERKgphuhe4OIaS",
                                                "R_3OpstLFIJhAjYSp",
                                                "R_3GE7SGDYilW9F48",
                                                "R_3CPcGnG8AXPKyIj",
                                                "R_2YybfcOxadjzDhC") ~ 0,
                             TRUE ~ control))

# amount of pp to exclude: 53
sum(raw_data$exclude == 1, na.rm=TRUE)

# save for later checking exclusions
exclusions <- raw_data %>% 
  dplyr::select(response_id, exclude, education) %>%
  filter(exclude == 1) 
  
# include those who were not sick
raw_data <- raw_data %>% 
  subset(is.na(exclude))

# 1147 unique participants left
length(unique(raw_data$response_id))

# mean duration in minutes: 16.6 (sd = 15.0) minutes
raw_data %>% 
  dplyr::summarise(mean_dur = (mean(duration_in_seconds)/60),
            sd_dur = (sd(duration_in_seconds)/60))

# day of the week - remove everything except day of the month (september 2022)
range(raw_data$recorded_date)

raw_data <- raw_data %>% 
  mutate(recorded_date1 = gsub("2022-09-", "", recorded_date)) %>% 
  mutate(day = gsub("\\s\\d+:\\d+:\\d+", "", recorded_date1)) %>% 
  mutate(day_of_week = case_when(day %in% c("07", "08", "09", "10", "13", "14") ~ "week")) %>% 
  mutate(day_of_week = case_when(day %in% c("11", "12") ~ "weekend",
                                 TRUE ~ day_of_week))

# remove weekend responses: 1144 left
raw_data <- raw_data %>% 
  filter(day_of_week == "week")

raw_data %>% 
  dplyr::select(day) %>% 
  dplyr::group_by(day) %>% 
  dplyr::count(day) %>%
  ungroup() %>% #otherwise sum(n) is sum of n by group()
  dplyr::mutate(percent = n/sum(n)) 

# remove unnecessary vars
raw_data <- raw_data %>% 
  dplyr::select(-c(start_date:recorded_date,
            distribution_channel:q_consent,
            liqin_test_number_1_1:liqin_test_number_6_1,
            exclude, recorded_date1, day_of_week))

clean_data <- raw_data %>% 
  mutate_at(vars(liqin_morning_number_1_1:liqin_morning_number_6_9), ~replace(., is.na(.), 0)) %>% 
  mutate_at(vars(liqin_afternoon_number_1_1:liqin_afternoon_number_6_6), ~replace(., is.na(.), 0)) %>% 
  mutate_at(vars(liqin_evening_number_1_1:liqin_evening_number_6_9), ~replace(., is.na(.), 0))
```

## Calculate BMI

Having downloaded from Qualtrics selecting numeric values has messed up height and weight measures so downloading these separately

```{r}
data_BMI <- "Representative_BMI.csv"
headers = read_csv(data_BMI, col_names = FALSE, n_max = 1) %>%
  as.character()
data_BMI = read_csv(data_BMI, skip = 3, col_names = FALSE)
colnames(data_BMI)= headers

data_BMI <- data_BMI %>% clean_names()

data_BMI <- data_BMI %>% 
  dplyr::select(response_id, height_unit:weight_other) %>% 
  dplyr::rename(pounds_only = weight_pounds) 
  
clean_data <- clean_data %>% 
  dplyr::select(-c(height_unit:weight_other))

# bind with clean_data
clean_data <- merge(clean_data, data_BMI, by = "response_id")

# unrealistic height
clean_data <- clean_data %>% 
  dplyr::mutate(height_feetinches = case_when(height_feetinches == "7 feet, 8 inches" ~ "6 feet, 8 inches", 
                               TRUE ~ height_feetinches))

# R_1LuN8QbLCEISdP5: 	I only weigh 79lbs but your weight scale started at 90lbs
clean_data <- clean_data %>% 
  mutate(pounds_only = case_when(response_id == "R_1LuN8QbLCEISdP5" ~ "79 pounds",
                                 TRUE ~ pounds_only))

# no participants did not report their weight and one did it manually
unique(clean_data$weight_other)

# split feet and inches and stones and pounds into two separate variables
clean_data <-
  clean_data %>% 
  separate(
    col = height_feetinches,
    into = c("height_feet", "height_inches"),
    sep = ",",
    remove = FALSE
  ) 

clean_data <-
  clean_data %>% 
  separate(
    col = weight_stonespounds,
    into = c("weight_stones", "weight_pounds"),
    sep = ",",
    remove = FALSE
  ) 

# only keep the number from all height- and weight- related variables
clean_data <-
  clean_data %>%
  mutate_at(
    vars(
      height_cm,
      height_feet,
      height_inches,
      weight_kg,
      weight_stones,
      weight_pounds,
      pounds_only
    ),
    list(~ parse_number(.))
  ) 

clean_data <- clean_data %>% 
  mutate(height_feet = as.numeric(height_feet)) %>% 
  mutate(height_inches = as.numeric(height_inches))

# transform all height and weight measures into cm and kg
clean_data <-
  clean_data %>% 
   mutate(
    height_cm = case_when(
      height_unit == "cm" ~ height_cm,
      height_unit == "feet and inches" ~ feet_inches_to_cm(height_feet, height_inches)
    ))

clean_data <-
  clean_data %>% 
   mutate(
    weight_kg = case_when(
      weight_unit == "kg" ~ weight_kg,
      weight_unit == "stones and pounds" ~ stones_pounds_to_kg(weight_pounds, weight_stones),
      weight_unit == "pounds only" ~ stones_pounds_to_kg(pounds_only)
    ))

# calculate Body Mass Index (BMI)
clean_data <- clean_data %>% 
  mutate(BMI = weight_kg/height_cm/height_cm*10000)

# there are zero pp who did not report their weight 
weight_BMI_grouped <- clean_data %>% 
  dplyr::group_by(pp) %>%
  dplyr::summarize(mean = mean(BMI, na.rm=TRUE)) %>% 
  dplyr::arrange(mean) 

sum(is.na(weight_BMI_grouped))

range(clean_data$BMI)
plot <- geom_plot(clean_data, BMI, "BMI")
plot
```

## Checking comments

Here I check the comments of participants and change their survey responses if they mention erroneous insertions etc. 

```{r}
# errors
clean_data %>%
  filter(!errors %in% c(NA, "no", "No", "NO", "n/a", 
                        "No.", "None", "none", "No errors")) %>% 
  select(pp, response_id, errors) %>% 
  DT::datatable(
  .,
  options = list(
    autoWidth = TRUE,
    scrollY = TRUE,
    scrollX = TRUE, 
    pageLength = 10
  ))

# none but I missed one morning coffee in normal cup as I clicked forward instead of moving down the chart, sorry!

pp_test <- clean_data %>%
  filter(response_id == "R_3OlvWZC2fQ9FyPf")

clean_data <- clean_data %>% 
  mutate(liqin_morning_number_1_2 = case_when(response_id == "R_3OlvWZC2fQ9FyPf" ~ 2, TRUE ~ liqin_morning_number_1_2)) %>% #type
   mutate(liqin_morning_number_2_2_1 = case_when(response_id == "R_3OlvWZC2fQ9FyPf" ~ 9, TRUE ~ liqin_morning_number_2_2_1)) %>% #specific drink
   mutate(liqin_morning_number_3_2_1 = case_when(response_id == "R_3OlvWZC2fQ9FyPf" ~ 11, TRUE ~ liqin_morning_number_3_2_1)) %>% #container
  mutate(liqin_morning_number_4_2 = case_when(response_id == "R_3OlvWZC2fQ9FyPf" ~ 5, TRUE ~ liqin_morning_number_4_2)) %>% #amount
  mutate(liqin_morning_number_6_2 = case_when(response_id == "R_3OlvWZC2fQ9FyPf" ~ 1, TRUE ~ liqin_morning_number_6_2)) #sugar

# comments
clean_data %>%
 filter(!comments %in% c(NA, "no", "No", "NO", "n/a", 
                        "No.", "None", "none", "N/A")) %>% 
  select(pp, response_id, comments) %>% 
  DT::datatable(
  .,
  options = list(
    autoWidth = TRUE,
    scrollY = TRUE,
    scrollX = TRUE, 
    pageLength = 10
  ))

#Was only given option for three drinks in afternoon. For statistical purposes, I had five pints of Guinness.

pp_test <- clean_data %>%
  filter(response_id == "R_2SGeFtQOWmXJBr9")

clean_data <- clean_data %>% 
  mutate(liqin_afternoon_number_4_4 = case_when(response_id == "R_2SGeFtQOWmXJBr9" ~ 7, TRUE ~ liqin_afternoon_number_4_4)) #amount

#My partner and I have been not flushing our toilet when we urinate to save water, so it's hard to say how dark my urine was yesterday. However, I was aware that I wasn't drinking as much as I usually do (4 pints of water) yesterday so I think it's safe to assume my urine was a little dark.

pp_test <- clean_data %>%
  filter(response_id == "R_2sZ3XmcAU52hC3e")

clean_data <- clean_data %>% 
  mutate(control = case_when(response_id == "R_2sZ3XmcAU52hC3e" ~ 1, TRUE ~ control)) #add to possible control cases

#water: I usually get a pint of water when I wake up and sip at this through the day. I may refill it once. So typically I drink 1-2 pints of tap water a day. I'm not sure if this was clear in the chart. 

# this participants has inputted water from container 3 multiple of 5 (in morning and afternoon) so here I decrease the amount

pp_test <- clean_data %>%
  filter(response_id == "R_2VIQcPNh1VZZ2Dc")

clean_data <- clean_data %>% 
  mutate(liqin_morning_number_4_1 = case_when(response_id == "R_2VIQcPNh1VZZ2Dc" ~ 3, TRUE ~ liqin_morning_number_4_1)) %>% #amount
  mutate(liqin_afternoon_number_4_4 = case_when(response_id == "R_2VIQcPNh1VZZ2Dc" ~ 3, TRUE ~ liqin_afternoon_number_4_4)) #amount

#Note - I was unable to accurately report on the drinks I had before breakfast and at lunch. I reported it as juice from a carton. But actually it was mostly water with a small amount add (about 20% of the glass), i.e. DILUTED juice. Sorry !

pp_test <- clean_data %>%
  filter(response_id == "R_2Vwrg6DWHDAAbKF")

clean_data <- clean_data %>% 
  mutate(liqin_morning_number_2_1_1 = case_when(response_id == "R_2Vwrg6DWHDAAbKF" ~ 25, TRUE ~ liqin_morning_number_2_1_1)) %>% #specific drink
  mutate(liqin_evening_number_2_1_1 = case_when(response_id == "R_2Vwrg6DWHDAAbKF" ~ 25, TRUE ~ liqin_evening_number_2_1_1)) #specific drink

#I went back to the lunch part of the survey, to add soup because I originally forgot it. I chose a mug as the container but I had a bowl - and a later question asked about soup. I hope I didn't do this incorrectly.

pp_test <- clean_data %>%
  filter(response_id == "R_2ZCFnbnskNdnj77")

# removing the soup record

clean_data <- clean_data %>% 
  mutate(liqin_afternoon_number_1_2 = case_when(response_id == "R_2ZCFnbnskNdnj77" ~ 0, TRUE ~ liqin_afternoon_number_1_2)) %>% #type
   mutate(liqin_afternoon_number_2_2_1 = case_when(response_id == "R_2ZCFnbnskNdnj77" ~ 0, TRUE ~ liqin_afternoon_number_2_2_1)) %>% #specific
   mutate(liqin_afternoon_number_3_2_1 = case_when(response_id == "R_2ZCFnbnskNdnj77" ~ 0, TRUE ~ liqin_afternoon_number_3_2_1)) %>% #container
  mutate(liqin_afternoon_number_4_2 = case_when(response_id == "R_2ZCFnbnskNdnj77" ~ 0, TRUE ~ liqin_afternoon_number_4_2)) %>% #amount
  mutate(liqin_afternoon_number_6_2 = case_when(response_id == "R_2ZCFnbnskNdnj77" ~ 0, TRUE ~ liqin_afternoon_number_6_2)) #sugar

#Ketogenic diet

pp_test <- clean_data %>%
  filter(response_id == "R_3nc4FGOALU4uW25")

clean_data <- clean_data %>% 
  mutate(exclusions_10 = case_when(response_id == "R_3nc4FGOALU4uW25" ~ 1, TRUE ~ exclusions_10)) %>% 
  mutate(exclusions_10_text = case_when(response_id == "R_3nc4FGOALU4uW25" ~ "ketogenic diet", TRUE ~ exclusions_10_text)) %>% 
  mutate(control = case_when(response_id == "R_3nc4FGOALU4uW25" ~ 1, TRUE ~ control)) # add person to control

#The first drink i entered was actually for the milk i drank from the bowl after my cereal but there was no option to convey that

pp_test <- clean_data %>%
  filter(response_id == "R_3stgi4JPeW34m3A")

# removing the milk record (they added it later in the cereal questions)
clean_data <- clean_data %>% 
  mutate(liqin_morning_number_1_1 = case_when(response_id == "R_3stgi4JPeW34m3A" ~ 0, TRUE ~ liqin_morning_number_1_1)) %>% #type
   mutate(liqin_morning_number_2_1_1 = case_when(response_id == "R_3stgi4JPeW34m3A" ~ 0, TRUE ~ liqin_morning_number_2_1_1)) %>% #specific
   mutate(liqin_morning_number_3_1_1 = case_when(response_id == "R_3stgi4JPeW34m3A" ~ 0, TRUE ~ liqin_morning_number_3_1_1)) %>% #container
  mutate(liqin_morning_number_4_1 = case_when(response_id == "R_3stgi4JPeW34m3A" ~ 0, TRUE ~ liqin_morning_number_4_1)) %>% #amount
  mutate(liqin_morning_number_6_1 = case_when(response_id == "R_3stgi4JPeW34m3A" ~ 0, TRUE ~ liqin_morning_number_6_1)) #sugar

#I drink a 500ml cup of tea but there was only an option for max 250ml

pp_test <- clean_data %>%
  filter(response_id == "R_PIo4xg4JRRAnbMd")

clean_data <- clean_data %>% 
  mutate(liqin_morning_number_4_4 = case_when(response_id == "R_PIo4xg4JRRAnbMd" ~ 6, TRUE ~ liqin_morning_number_4_4)) %>% #amount
    mutate(liqin_morning_number_4_7 = case_when(response_id == "R_PIo4xg4JRRAnbMd" ~ 6, TRUE ~ liqin_morning_number_4_7)) %>% #amount
    mutate(liqin_morning_number_4_8 = case_when(response_id == "R_PIo4xg4JRRAnbMd" ~ 6, TRUE ~ liqin_morning_number_4_8)) %>% #amount
    mutate(liqin_afternoon_number_4_1 = case_when(response_id == "R_PIo4xg4JRRAnbMd" ~ 6, TRUE ~ liqin_afternoon_number_4_1)) %>% #amount
    mutate(liqin_afternoon_number_4_4 = case_when(response_id == "R_PIo4xg4JRRAnbMd" ~ 6, TRUE ~ liqin_afternoon_number_4_4)) %>% #amount
    mutate(liqin_evening_number_4_5 = case_when(response_id == "R_PIo4xg4JRRAnbMd" ~ 6, TRUE ~ liqin_evening_number_4_5))  #amount

#R_udBkRVVMA4xzETn	MY TWO 'OTHER DRINKS' WERE PROTEIN SHAKES MADE WITH COLD WATER AND COLD MILK

#in the exercise section I put walking time as 3, I meant 3 hours not 3 minutes so should have put 180. Apologies.

pp_test <- clean_data %>%
  filter(response_id == "R_Uiuhn4doWD7llYZ")

clean_data <- clean_data %>% 
  mutate(ipaq_number_1_3_1 = case_when(response_id == "R_Uiuhn4doWD7llYZ" ~ "180", TRUE ~ ipaq_number_1_3_1))

#When asked about milk, I answered 'Yes' I drank oat milk / drink, with breakfast.

pp_test <- clean_data %>%
  filter(response_id == "R_wTRXzZMRjOX8dsl")

clean_data <- clean_data %>% 
  mutate(cereal = case_when(response_id == "R_wTRXzZMRjOX8dsl" ~ 1, TRUE ~ cereal)) %>% #recode to no milk with cereal
  mutate(cereal_container = case_when(response_id == "R_wTRXzZMRjOX8dsl" ~ NA_real_, TRUE ~ cereal_container)) %>% 
  mutate(liqin_morning_number_1_4 = case_when(response_id == "R_wTRXzZMRjOX8dsl" ~ 3, TRUE ~ liqin_morning_number_1_4)) %>% 
  mutate(liqin_morning_number_2_4_1 = case_when(response_id == "R_wTRXzZMRjOX8dsl" ~ 12, TRUE ~ liqin_morning_number_2_4_1)) %>%
    mutate(liqin_morning_number_3_4_1 = case_when(response_id == "R_wTRXzZMRjOX8dsl" ~ 3, TRUE ~ liqin_morning_number_3_4_1)) %>%
    mutate(liqin_morning_number_4_4 = case_when(response_id == "R_wTRXzZMRjOX8dsl" ~ 5, TRUE ~ liqin_morning_number_4_4)) %>% 
    mutate(liqin_morning_number_6_4 = case_when(response_id == "R_wTRXzZMRjOX8dsl" ~ 1, TRUE ~ liqin_morning_number_6_4)) 
```

## Data wrangling

## Clean entries

Here I check whether all drink inputs have all the values and fix it when, for instance, pp have input a drink on two separate lines. 

```{r, results = "hide"}
clean_data <- as.data.frame(clean_data)

# lengths must match so adding 3 empty columns per drink aspect for afternoon
clean_data <- clean_data %>% 
  add_column(liqin_afternoon_number_1_7 = NA,
             liqin_afternoon_number_1_8 = NA, 
             liqin_afternoon_number_1_9 = NA, 
             liqin_afternoon_number_2_7_1 = NA,
             liqin_afternoon_number_2_8_1 = NA,
             liqin_afternoon_number_2_9_1 = NA, 
             liqin_afternoon_number_3_7_1 = NA,
             liqin_afternoon_number_3_8_1 = NA,
             liqin_afternoon_number_3_9_1 = NA,
             liqin_afternoon_number_4_7 = NA,
             liqin_afternoon_number_4_8 = NA,
             liqin_afternoon_number_4_9 = NA,
             liqin_afternoon_number_5_7 = NA,
             liqin_afternoon_number_5_8 = NA,
             liqin_afternoon_number_5_9 = NA,
             liqin_afternoon_number_6_7 = NA,
             liqin_afternoon_number_6_8 = NA,
             liqin_afternoon_number_6_9 = NA)

# create loop
# rename some vars before looping
clean_data <- clean_data %>%
  dplyr::select(response_id, pp, 
                liqin_morning_number_1_1:liqin_morning_number_1_9,
                liqin_morning_number_2_1_1:liqin_morning_number_3_9_1,
                liqin_morning_number_4_1:liqin_morning_number_6_9,
                liqin_afternoon_number_1_1:liqin_afternoon_number_1_9,
                liqin_afternoon_number_2_1_1:liqin_afternoon_number_3_9_1,
                liqin_afternoon_number_4_1:liqin_afternoon_number_6_9,
                liqin_evening_number_1_1:liqin_evening_number_1_9,
                liqin_evening_number_2_1_1:liqin_evening_number_3_9_1,
                liqin_evening_number_4_1:liqin_evening_number_6_9) %>% 
  rename_at(vars(starts_with("liqin_morning_number_2")),
            ~ sub("_1", "", .)) %>% 
   rename_at(vars(starts_with("liqin_morning_number_3")),
            ~ sub("_1", "", .)) %>% 
  rename_at(vars(starts_with("liqin_afternoon_number_2")),
            ~ sub("_1", "", .)) %>% 
   rename_at(vars(starts_with("liqin_afternoon_number_3")),
            ~ sub("_1", "", .)) %>% 
  rename_at(vars(starts_with("liqin_evening_number_2")),
            ~ sub("_1", "", .)) %>% 
   rename_at(vars(starts_with("liqin_evening_number_3")),
            ~ sub("_1", "", .)) 

# create df for loop
input <- data.frame(0)
pp <- integer(0)
response_id <- integer(0)

# for j in each pp, for i of each drink
for (j  in 1:nrow(clean_data)){
  for (i in 1:9) {
    # create variables names to loop through
    v1 <- paste("liqin_morning_number_1", i, sep = "_")
    v2 <- paste("liqin_morning_number_2", i, sep = "_")
    v3 <- paste("liqin_morning_number_3", i, sep = "_")
    v4 <- paste("liqin_morning_number_4", i, sep = "_")
    if(clean_data[[v1]][j] ==  0 & clean_data[[v2]][j] == 0 &
        clean_data[[v3]][j] ==  0 & clean_data[[v4]][j] ==  0) {
      print("Do nothing")
      } 
    else if(clean_data[[v1]][j] ==  0 | clean_data[[v2]][j] == 0 |
       clean_data[[v3]][j] ==  0 | clean_data[[v4]][j] ==  0)
    {
      pp[j] <- clean_data$pp[j]
      response_id[j] <- clean_data$response_id[j]
      input <- cbind(pp, response_id)
      }
    else {print("Do absolutely nothing")
    }
  }
  }

input <- input %>% 
  as.data.frame() %>% 
  na.omit()

# select pp ids to select those that need to be inspected
ids <- input$response_id

selection <- clean_data %>% 
  filter(response_id %in% ids)

# fix missing inputs/inconsistencies (by checking original survey in Qualtrics data)
clean_data <- clean_data %>% 
   dplyr::mutate(liqin_morning_number_2_7 = case_when(response_id == "R_12gvjRcRXwdsvke" ~ 2, TRUE ~ liqin_morning_number_2_7)) %>% 
  mutate(liqin_afternoon_number_2_3 = case_when(response_id == "R_12gvjRcRXwdsvke" ~ 0, TRUE ~ liqin_afternoon_number_2_3)) %>% 
  mutate(liqin_afternoon_number_2_4 = case_when(response_id == "R_12gvjRcRXwdsvke" ~ 4, TRUE ~ liqin_afternoon_number_2_4)) %>% 
  mutate(liqin_afternoon_number_3_3 = case_when(response_id == "R_12gvjRcRXwdsvke" ~ 0, TRUE ~ liqin_afternoon_number_3_3)) %>% 
  mutate(liqin_afternoon_number_3_4 = case_when(response_id == "R_12gvjRcRXwdsvke" ~ 2, TRUE ~ liqin_afternoon_number_3_4)) %>% 
  mutate(liqin_afternoon_number_4_3 = case_when(response_id == "R_12gvjRcRXwdsvke" ~ 0, TRUE ~ liqin_afternoon_number_4_3)) %>% 
  mutate(liqin_afternoon_number_4_4 = case_when(response_id == "R_12gvjRcRXwdsvke" ~ 5, TRUE ~ liqin_afternoon_number_4_4)) %>% 
  mutate(liqin_afternoon_number_6_3 = case_when(response_id == "R_12gvjRcRXwdsvke" ~ 0, TRUE ~ liqin_afternoon_number_6_3)) %>% 
  mutate(liqin_afternoon_number_6_4 = case_when(response_id == "R_12gvjRcRXwdsvke" ~ 1, TRUE ~ liqin_afternoon_number_6_4)) %>% 
  mutate(liqin_afternoon_number_6_4 = case_when(response_id == "R_1DBaXg1aEdzKrJo" ~ 1, TRUE ~ liqin_afternoon_number_6_4)) %>% 
  mutate(liqin_morning_number_3_7 = case_when(response_id == "R_1DBaXg1aEdzKrJo" ~ 11, TRUE ~ liqin_morning_number_3_7)) %>% 
  mutate(liqin_morning_number_1_4 = case_when(response_id == "R_1Fg1N53MVLNmoUZ" ~ 0, TRUE ~ liqin_morning_number_1_4)) %>% 
  mutate(liqin_morning_number_1_5 = case_when(response_id == "R_1Fg1N53MVLNmoUZ" ~ 7, TRUE ~ liqin_morning_number_1_5)) %>% 
  mutate(liqin_morning_number_1_1 = case_when(response_id == "R_1MKffJOqxotz2zV" ~ 0, TRUE ~ liqin_morning_number_1_1)) %>% 
  mutate(liqin_morning_number_1_6 = case_when(response_id == "R_1OjHUht0zRqzDak" ~ 2, TRUE ~ liqin_morning_number_1_6)) %>% 
  mutate(liqin_morning_number_1_7 = case_when(response_id == "R_1OjHUht0zRqzDak" ~ 0, TRUE ~ liqin_morning_number_1_7)) %>% 
  mutate(liqin_morning_number_1_2 = case_when(response_id == "R_2f8PmReJT6JoZ0e" ~ 2, TRUE ~ liqin_morning_number_1_2)) %>% 
  mutate(liqin_morning_number_1_4 = case_when(response_id == "R_2f8PmReJT6JoZ0e" ~ 0, TRUE ~ liqin_morning_number_1_4)) %>% 
  mutate(liqin_morning_number_4_8 = case_when(response_id == "R_2rVPTTVUC5p7ecF" ~ 4, TRUE ~ liqin_morning_number_4_8)) %>% 
  mutate(liqin_evening_number_3_6 = case_when(response_id == "R_2rVPTTVUC5p7ecF" ~ 11, TRUE ~ liqin_evening_number_3_6)) %>% 
  mutate(liqin_morning_number_2_1 = case_when(response_id == "R_2YbpRSTsCiblj4L" ~ 1, TRUE ~ liqin_morning_number_2_1)) %>% 
  mutate(liqin_morning_number_1_9 = case_when(response_id == "R_UucivP7A7hjODUl" ~ 1, TRUE ~ liqin_morning_number_1_9)) %>% 
  mutate(liqin_morning_number_4_2 = case_when(response_id == "R_3Pc4pBHgSB0wAlt" ~ 5, TRUE ~ liqin_morning_number_4_2)) %>% 
  mutate(liqin_morning_number_1_3 = case_when(response_id == "R_1Cr2OuejrJmWsMF" ~ 0, TRUE ~ liqin_morning_number_1_3)) 

# dealth with earlier: R_2cpGYhLA6TsaS19 missing hot drink specific type
```

### Cereal and soup

Recalculating cereal and soup consumption as an extra drink. 

```{r}
#soup
clean_data <- clean_data %>% 
  mutate(soup_ml = case_when(soup == 2 & soup_container == 3 ~ 300,
                                soup == 2 & soup_container == 4 ~ 450,
                                soup == 2 & soup_container == 5 ~ 600,
                             TRUE ~ 0)) %>% 
  select(-c(soup, soup_container))

#cereal with milk
clean_data <- clean_data %>% 
  mutate(cereal_ml = case_when(cereal == 2 & cereal_container == 3 ~ 300,
                                cereal == 2 & cereal_container == 4 ~ 450,
                                cereal == 2 & cereal_container == 5 ~ 600,
                             TRUE ~ 0)) %>% 
  select(-c(cereal, cereal_container))
```

## Compute no. of drinks consumed
```{r}
clean_data <- clean_data %>% 
  mutate(drinks_no = liqin_morning_number_1_1+liqin_morning_number_1_2+liqin_morning_number_1_3+liqin_morning_number_1_4+liqin_morning_number_1_5+liqin_morning_number_1_6+liqin_morning_number_1_7+
                  liqin_afternoon_number_1_1+liqin_afternoon_number_1_2+liqin_afternoon_number_1_3+liqin_afternoon_number_1_4+liqin_afternoon_number_1_5+
                  liqin_evening_number_1_1+liqin_evening_number_1_2+liqin_evening_number_1_3+liqin_evening_number_1_4+liqin_evening_number_1_5) %>% 
  mutate(drinks_no = as.numeric(drinks_no))

# mean no. of drinks and sd
clean_data %>% 
  dplyr::summarize(mean_no = mean(drinks_no),
       sd_no = sd(drinks_no))
```
## From wide to long
```{r}
clean_data <- stats::reshape(clean_data, 
                     idvar="pp",
                     direction="long",
                     varying =  list(c("liqin_morning_number_1_1", #drink type
                                  "liqin_morning_number_1_2", 
                                  "liqin_morning_number_1_3", 
                                  "liqin_morning_number_1_4",
                                  "liqin_morning_number_1_5", 
                                  "liqin_morning_number_1_6",
                                  "liqin_morning_number_1_7", 
                                  "liqin_morning_number_1_8",
                                  "liqin_morning_number_1_9", 
                                  "liqin_afternoon_number_1_1", 
                                  "liqin_afternoon_number_1_2", 
                                  "liqin_afternoon_number_1_3", 
                                  "liqin_afternoon_number_1_4", 
                                  "liqin_afternoon_number_1_5", 
                                  "liqin_afternoon_number_1_6", 
                                  "liqin_afternoon_number_1_7", 
                                  "liqin_afternoon_number_1_8", 
                                  "liqin_afternoon_number_1_9", 
                                  "liqin_evening_number_1_1",
                                  "liqin_evening_number_1_2",
                                  "liqin_evening_number_1_3",
                                  "liqin_evening_number_1_4",
                                  "liqin_evening_number_1_5",
                                  "liqin_evening_number_1_6",
                                  "liqin_evening_number_1_7",
                                  "liqin_evening_number_1_8",
                                  "liqin_evening_number_1_9"),
                                   c("liqin_morning_number_2_1", #specific drink
                                  "liqin_morning_number_2_2",
                                  "liqin_morning_number_2_3",
                                  "liqin_morning_number_2_4",
                                  "liqin_morning_number_2_5",
                                  "liqin_morning_number_2_6",
                                  "liqin_morning_number_2_7",
                                  "liqin_morning_number_2_8",
                                  "liqin_morning_number_2_9",
                                  "liqin_afternoon_number_2_1",
                                  "liqin_afternoon_number_2_2",
                                  "liqin_afternoon_number_2_3",
                                  "liqin_afternoon_number_2_4",
                                  "liqin_afternoon_number_2_5",
                                  "liqin_afternoon_number_2_6",
                                  "liqin_afternoon_number_2_7",
                                  "liqin_afternoon_number_2_8",
                                  "liqin_afternoon_number_2_9",
                                  "liqin_evening_number_2_1",
                                  "liqin_evening_number_2_2",
                                  "liqin_evening_number_2_3",
                                  "liqin_evening_number_2_4",
                                  "liqin_evening_number_2_5",
                                  "liqin_evening_number_2_6",
                                  "liqin_evening_number_2_7",
                                  "liqin_evening_number_2_8",
                                  "liqin_evening_number_2_9"),
                                  c("liqin_morning_number_3_1",  #container
                                  "liqin_morning_number_3_2",
                                  "liqin_morning_number_3_3",
                                  "liqin_morning_number_3_4",
                                  "liqin_morning_number_3_5",
                                  "liqin_morning_number_3_6",
                                  "liqin_morning_number_3_7",
                                  "liqin_morning_number_3_8",
                                  "liqin_morning_number_3_9",
                                  "liqin_afternoon_number_3_1",
                                  "liqin_afternoon_number_3_2",
                                  "liqin_afternoon_number_3_3",
                                  "liqin_afternoon_number_3_4",
                                  "liqin_afternoon_number_3_5",
                                  "liqin_afternoon_number_3_6",
                                  "liqin_afternoon_number_3_7",
                                  "liqin_afternoon_number_3_8",
                                  "liqin_afternoon_number_3_9",
                                  "liqin_evening_number_3_1",
                                  "liqin_evening_number_3_2",
                                  "liqin_evening_number_3_3",
                                  "liqin_evening_number_3_4",
                                  "liqin_evening_number_3_5",
                                  "liqin_evening_number_3_6",
                                  "liqin_evening_number_3_7",
                                  "liqin_evening_number_3_8",
                                  "liqin_evening_number_3_9"), 
                                   c("liqin_morning_number_4_1", #amount
                                  "liqin_morning_number_4_2",
                                  "liqin_morning_number_4_3",
                                  "liqin_morning_number_4_4",
                                  "liqin_morning_number_4_5",
                                  "liqin_morning_number_4_6",
                                  "liqin_morning_number_4_7",
                                  "liqin_morning_number_4_8",
                                  "liqin_morning_number_4_9",
                                  "liqin_afternoon_number_4_1",
                                  "liqin_afternoon_number_4_2",
                                  "liqin_afternoon_number_4_3",
                                  "liqin_afternoon_number_4_4",
                                  "liqin_afternoon_number_4_5",
                                  "liqin_afternoon_number_4_6",
                                  "liqin_afternoon_number_4_7",
                                  "liqin_afternoon_number_4_8",
                                  "liqin_afternoon_number_4_9",
                                  "liqin_evening_number_4_1",
                                  "liqin_evening_number_4_2",
                                  "liqin_evening_number_4_3",
                                  "liqin_evening_number_4_4",
                                  "liqin_evening_number_4_5",
                                  "liqin_evening_number_4_6",
                                  "liqin_evening_number_4_7",
                                  "liqin_evening_number_4_8",
                                  "liqin_evening_number_4_9"),
                                  c("liqin_morning_number_5_1", #moment
                                  "liqin_morning_number_5_2",
                                  "liqin_morning_number_5_3",
                                  "liqin_morning_number_5_4",
                                  "liqin_morning_number_5_5",
                                  "liqin_morning_number_5_6",
                                  "liqin_morning_number_5_7",
                                  "liqin_morning_number_5_8",
                                  "liqin_morning_number_5_9",
                                  "liqin_afternoon_number_5_1",
                                  "liqin_afternoon_number_5_2",
                                  "liqin_afternoon_number_5_3",
                                  "liqin_afternoon_number_5_4",
                                  "liqin_afternoon_number_5_5",
                                  "liqin_afternoon_number_5_6",
                                  "liqin_afternoon_number_5_7",
                                  "liqin_afternoon_number_5_8",
                                  "liqin_afternoon_number_5_9",
                                  "liqin_evening_number_5_1",
                                  "liqin_evening_number_5_2",
                                  "liqin_evening_number_5_3",
                                  "liqin_evening_number_5_4",
                                  "liqin_evening_number_5_5",
                                  "liqin_evening_number_5_6",
                                  "liqin_evening_number_5_7",
                                  "liqin_evening_number_5_8",
                                  "liqin_evening_number_5_9"),
                                  c("liqin_morning_number_6_1", #sugar
                                  "liqin_morning_number_6_2",
                                  "liqin_morning_number_6_3", 
                                  "liqin_morning_number_6_4",
                                  "liqin_morning_number_6_5", 
                                  "liqin_morning_number_6_6",
                                  "liqin_morning_number_6_7", 
                                  "liqin_morning_number_6_8",
                                  "liqin_morning_number_6_9",
                                  "liqin_afternoon_number_6_1",
                                  "liqin_afternoon_number_6_2",
                                  "liqin_afternoon_number_6_3",
                                  "liqin_afternoon_number_6_4",
                                  "liqin_afternoon_number_6_5",
                                  "liqin_afternoon_number_6_6",
                                  "liqin_afternoon_number_6_7",
                                  "liqin_afternoon_number_6_8",
                                  "liqin_afternoon_number_6_9",
                                  "liqin_evening_number_6_1",
                                  "liqin_evening_number_6_2",
                                  "liqin_evening_number_6_3",
                                  "liqin_evening_number_6_4",
                                  "liqin_evening_number_6_5",
                                  "liqin_evening_number_6_6",
                                  "liqin_evening_number_6_7",
                                  "liqin_evening_number_6_8",
                                  "liqin_evening_number_6_9")),
                     v.names = c("drink_type", "drink_code", "container_code", "amount", "moment", "sugar"),
                     times = c("morning_drink1", 
                               "morning_drink2", 
                               "morning_drink3", 
                               "morning_drink4", 
                               "morning_drink5", 
                               "morning_drink6", 
                               "morning_drink7", 
                               "morning_drink8", 
                               "morning_drink9",
                               "afternoon_drink1", 
                               "afternoon_drink2", 
                               "afternoon_drink3", 
                               "afternoon_drink4", 
                               "afternoon_drink5", 
                               "afternoon_drink6", 
                               "afternoon_drink7", 
                               "afternoon_drink8", 
                               "afternoon_drink9",
                               "evening_drink1", 
                               "evening_drink2",
                               "evening_drink3", 
                               "evening_drink4",
                               "evening_drink5", 
                               "evening_drink6",
                               "evening_drink7", 
                               "evening_drink8",
                               "evening_drink9"),
                     timevar= "time_drink",
                     new.row.names = NULL)

# remove if drink_type, drink_code, container_code, amount is 0
# select those who have 0 values
test_no <- clean_data %>% 
  filter(drink_type == 0 & drink_code == 0 & container_code == 0 & amount == 0)

# deal with some missing values that were identified later
test_missing <- clean_data %>% 
  filter(drink_type == 2 & drink_code == 0)

clean_data <- clean_data %>% 
  dplyr::mutate(drink_code = case_when(drink_type == 2 & drink_code == 0 ~ 11, 
                                       TRUE ~ drink_code)) # NA = other hot drink

# remove these rows: 8740 rows left
clean_data <- clean_data %>% 
  filter(drink_type != 0 & drink_code != 0 & container_code != 0 & amount != 0)

# check if missing var on one of these values drink_type, drink_code, container_code, amount is 0
# check 0 values
test_missing <- clean_data %>% 
  filter(drink_type == 0 | drink_code == 0 | container_code == 0 | amount == 0)
```

## Check inconsistencies

Here I check whether names and codes inputted by participants make sense. 

```{r}
# recode drink_type and drink_code into names
clean_data <- clean_data %>% 
  dplyr::mutate(drink_type_name = case_when(drink_type == 1 ~ "water",
                                drink_type == 2 ~ "hot drinks",
                                drink_type == 3 ~ "milk drinks",
                                drink_type == 4 ~ "soft/flavoured beverages",
                                drink_type == 5 ~ "diet beverages",
                                drink_type == 6 ~ "alcohol",
                                drink_type == 7 ~ "other")) %>% 
  mutate(drink_code_name = case_when(drink_code == 1 ~ "tap water",
                                drink_code == 2 ~ "water from cooler/fountain",
                                drink_code == 3 ~ "non-carbonated bottled water",
                                drink_code == 4 ~ "carbonated bottled water",
                                drink_code == 5 ~ "flavoured non-carbonated bottled water",
                                drink_code == 6 ~ "flavoured carbonated bottled water",
                                drink_code == 7 ~ "coffee",
                                drink_code== 8 ~ "hot chocolate/cacao/cappucino",
                                drink_code== 9 ~ "tea",
                                drink_code== 10 ~ "herbal tea",
                                drink_code== 11 ~ "other hot drink",
                                drink_code== 12 ~ "milk",
                                drink_code== 13 ~ "flavoured milk",
                                drink_code== 14 ~ "drinking yoghurt",
                                drink_code== 15 ~ "smoothies",
                                drink_code== 16 ~ "other milk drink",
                                drink_code== 17 ~ "carbonated soft drink",
                                drink_code== 18 ~ "non-carbonated sweet drink",
                                drink_code== 19 ~ "ice tea",
                                drink_code== 20 ~ "ice coffee",
                                drink_code== 21 ~ "packaged fruit juice",
                                drink_code== 22 ~ "freshly squeezed fruit juice",
                                drink_code== 23 ~ "fruit based smoothies",
                                drink_code== 24 ~ "fruit nectar",
                                drink_code== 25 ~ "other sweet drink",
                                drink_code== 26 ~ "vegetable juice",
                                drink_code== 27 ~ "energy drink",
                                drink_code== 28 ~ "sports drink",
                                drink_code== 29 ~ "diet non-carbonated drink",
                                drink_code== 30 ~ "diet carbonated drink",
                                drink_code== 31 ~ "diet ice tea",
                                drink_code== 32 ~ "diet ice coffee",
                                drink_code== 33 ~ "diet energy drinks",
                                drink_code== 34 ~ "beer or cider",
                                drink_code== 35 ~ "wine",
                                drink_code== 36 ~ "spirits without mixer",
                                drink_code== 37 ~ "spirits with mixer",
                                drink_code== 38 ~ "other alcoholic drinks",
                                drink_code== 39 ~ "other drink")) %>%
  mutate(amount_sugar = case_when(sugar == 0 ~ 0,
                                  sugar == 1 ~ 0,
                                  sugar == 2 ~ 0.5,
                                  sugar == 3 ~ 1,
                                  sugar == 4 ~ 2))

# check whether drink_type_name and drink_code_name match (TRUE/FALSE)
# if not, take the more specific drink_code_name

`%ni%` <- Negate(`%in%`)

input <- data.frame(0,0)
evaluation <- integer(0)
pp_number <- integer(0)
pp_id <- integer(0)
drink <- integer(0)
drink_type <- integer(0)

for (i in 1:nrow(clean_data)) {
if(clean_data$drink_type_name[i] == "water" && clean_data$drink_code_name[i] %ni% c("tap water", "water from cooler/fountain", "non-carbonated bottled water", "carbonated bottled water", "flavoured non-carbonated bottled water", "flavoured carbonated bottled water", "other drink") |
   clean_data$drink_type_name[i] == "hot drinks" && clean_data$drink_code_name[i] %ni% c("coffee", "hot chocolate/cacao/cappucino", "tea", "herbal tea", "other hot drink") |
   clean_data$drink_type_name[i] == "milk drinks" && clean_data$drink_code_name[i] %ni% c("milk", "flavoured milk", "drinking yoghurt", "smoothies", "other milk drink") |
   clean_data$drink_type_name[i] == "soft/flavoured beverages" && clean_data$drink_code_name[i] %ni% c("carbonated soft drink", "non-carbonated sweet drink", "ice tea", "ice coffee", "packaged fruit juice", "freshly squeezed fruit juice", "fruit based smoothies", "fruit nectar", "other sweet drink", "vegetable juice", "energy drink","sports drink", "other drink") |
   clean_data$drink_type_name[i] == "diet beverages" &&  clean_data$drink_code_name[i] %ni% c("diet non-carbonated drink", "diet carbonated drink", "diet ice tea", 
"diet ice coffee",  "diet energy drinks", "other drink") |
   clean_data$drink_type_name[i] == "alcohol" &&  clean_data$drink_code_name[i] %ni% c("beer or cider","wine", "spirits without mixer", "spirits with mixer", "other alcoholic drinks") |
   clean_data$drink_type_name[i] == "other" &&  clean_data$drink_code_name[i] %ni% c("other drink")
)
  {pp_number[i] <- clean_data$pp[i]
  pp_id[i] <- clean_data$response_id[i]
  drink_type[i] <- clean_data$drink_type_name[i]
  drink[i] <- clean_data$drink_code_name[i]
  input <- cbind(evaluation, pp_number, pp_id, drink_type, drink)
}
}

input <- input %>% 
  as.data.frame() %>% 
  na.omit()

# remember the codes need to be changed as well if those are the ones used later on
clean_data <- clean_data %>% 
  mutate(drink_type_name = case_when(drink_type_name == "other" & drink_code_name %in% c("carbonated soft drink", "energy drink", "freshly squeezed fruit juice", "fruit based smoothies", "non-carbonated sweet drink", "other sweet drink", "packaged fruit juice", "vegetable juice") ~ "soft/flavoured beverages",
                                     TRUE ~ drink_type_name)) %>% 
  mutate(drink_type_name = case_when(drink_type_name == "other" & drink_code_name %in% c("coffee", "other hot drink") ~ "hot drinks",
                                     TRUE ~ drink_type_name)) %>% 
  mutate(drink_type_name = case_when(drink_type_name == "other" & drink_code_name %in% "smoothies" ~ "milk drinks",
                                     TRUE ~ drink_type_name)) 

# change all the inconsistencies: went through Qualtrics survey manually to check e.g., when container code + drink code are mixed up

clean_data <- clean_data %>% 
   mutate(container_code = case_when(response_id == "R_2TBhWKac2DK91Xt" & drink_type_name == "alcohol" ~ 4, TRUE ~ container_code)) %>% 
  mutate(drink_code_name = case_when(response_id == "R_2TBhWKac2DK91Xt" & drink_type_name == "alcohol" ~ "spirits without mixer", TRUE ~ drink_code_name)) %>% 
     mutate(drink_code_name = case_when(response_id == "R_2cvlQxCsDsnTGpd" & drink_type_name == "hot drinks" & drink_code_name == "carbonated bottled water" ~ "tea", TRUE ~ drink_code_name)) %>% 
  #if diet carbonated drink is selected, drink_type should be diet beverages
  mutate(drink_type_name = case_when(drink_code_name == "diet carbonated drink" ~ "diet beverages", TRUE ~ drink_type_name)) %>% 
  
   mutate(drink_code_name = case_when(response_id == "R_1gnzRRLF1jMJgJ0" & drink_type_name == "hot drinks" & drink_code_name == "carbonated soft drink" ~ "tea", TRUE ~ drink_code_name)) %>%
  #this person drank flavoured non-carbonated water in all other instances
  mutate(drink_code_name = case_when(response_id == "R_80rFSjR4gCCzDKV" & drink_type_name == "water" & drink_code_name == "carbonated soft drink" ~ "flavoured non-carbonated bottled water", TRUE ~ drink_code_name)) %>%
  #CHECK
   mutate(drink_code_name = case_when(response_id == "R_31MHI3HemJZj5Xk" & drink_type_name == "water" & drink_code_name == "carbonated soft drink" ~ "non-carbonated bottled water", TRUE ~ drink_code_name)) %>%
  
     mutate(container_code = case_when(response_id == "R_1onUPngUlcxW4vW" & drink_type_name == "water" & drink_code_name == "carbonated soft drink" ~ 17, TRUE ~ container_code)) %>% 
  
   mutate(drink_code_name = case_when(response_id == "R_1onUPngUlcxW4vW" & drink_type_name == "water" & drink_code_name == "carbonated soft drink" ~ "tap water", TRUE ~ drink_code_name)) %>%
  
  mutate(drink_type_name = case_when(drink_code_name == "coffee" ~ "hot drinks",
                                     TRUE ~ drink_type_name)) %>% 
   # if drink type is diet beverages, drink code should be diet energy, not soft drink
    mutate(drink_code_name = case_when(drink_type_name == "diet beverages" & drink_code_name == "carbonated soft drink" ~ "diet energy drinks",
                                     TRUE ~ drink_code_name)) %>% 
  
   mutate(drink_type_name = case_when(drink_code_name == "diet energy drinks" ~ "diet beverages",
                                     TRUE ~ drink_type_name)) %>% 
  
  mutate(drink_type_name = case_when(drink_code_name == "diet non-carbonated drink" ~ "diet beverages",
                                     TRUE ~ drink_type_name)) %>% 
  
   mutate(drink_code_name = case_when(drink_type_name == "diet beverages" & drink_code_name == "energy drink" ~ "diet energy drinks",
                                     TRUE ~ drink_code_name)) %>% 
  
     mutate(drink_type_name = case_when(drink_type_name == "diet beverages" & drink_code_name == "flavoured carbonated bottled water" ~ "water",
                                     TRUE ~ drink_type_name)) %>% 
  
 mutate(drink_type_name = case_when(drink_code_name == "flavoured carbonated bottled water" ~ "water",
                                     TRUE ~ drink_type_name)) %>% 
  
    mutate(drink_type_name = case_when(response_id == "R_XhV4MRz1n2vL93H" & drink_type_name == "soft/flavoured beverages" & drink_code_name == "flavoured milk" ~ "milk drinks", TRUE ~ drink_type_name)) %>%
  
       mutate(drink_type_name = case_when(drink_code_name == "flavoured non-carbonated bottled water" ~ "water",
                                     TRUE ~ drink_type_name)) %>% 
  
   mutate(drink_type_name = case_when(drink_code_name == "freshly squeezed fruit juice" ~ "soft/flavoured beverages",
                                     TRUE ~ drink_type_name)) %>%
  
    mutate(drink_type_name = case_when(response_id == "R_Pzld6zaZaSMkyT7" & drink_type_name == "milk drinks" & drink_code_name == "hot chocolate/cacao/cappucino" ~ "hot drinks", TRUE ~ drink_type_name)) %>% 
  
  mutate(drink_type_name = case_when(response_id == "R_1MWi1ASx9JuOV6k" & drink_type_name == "milk drinks" & drink_code_name == "ice coffee" ~ "soft/flavoured beverages", TRUE ~ drink_type_name)) %>% 
  
    mutate(container_code = case_when(response_id == "R_3O8QA0GyNVl5Yd3" & drink_type_name == "water" & drink_code_name == "ice tea" ~ 19, TRUE ~ container_code)) %>% 
  mutate(drink_code_name = case_when(response_id == "R_3O8QA0GyNVl5Yd3" & drink_type_name == "water" & drink_code_name == "ice tea" ~ "non-carbonated bottled water", TRUE ~ drink_code_name)) %>% 
  
   mutate(drink_type_name = case_when(drink_code_name == "milk"  ~ "milk drinks",
                                     TRUE ~ drink_type_name)) %>% 
  
    mutate(drink_type_name = case_when(drink_code_name == "non-carbonated bottled water" ~ "water",
                                     TRUE ~ drink_type_name)) %>%
  
         mutate(drink_code_name = case_when(drink_type_name == "alcohol" & drink_code_name == "other drink" ~ "other alcoholic drinks", TRUE ~ drink_code_name)) %>% 
  
    mutate(drink_code_name = case_when(response_id == "R_2PBfck5quEz60ZP" & drink_type_name == "soft/flavoured beverages" & drink_code_name == "other hot drink" ~ "other drink", TRUE ~ drink_code_name)) %>% 
  # hot water
    mutate(drink_code_name = case_when(response_id == "R_yqIc4uHtJwX4ynn" & drink_type_name == "water" & drink_code_name == "other hot drink" ~ "tap water", TRUE ~ drink_code_name)) %>%
  
   mutate(drink_type_name = case_when(response_id == "R_1FDGfYjFbZdQlAW" & drink_type_name == "other" & drink_code_name == "other milk drink" ~ "milk drinks", TRUE ~ drink_type_name)) %>% 
  
  mutate(drink_type_name = case_when(response_id == "R_1FDGfYjFbZdQlAW" & drink_type_name == "other" & drink_code_name == "other milk drink" ~ "milk drinks", TRUE ~ drink_type_name)) %>% 
mutate(drink_code_name = case_when(response_id == "R_1jj4CqQwcKIOYUm" & drink_type_name == "hot drinks"  & drink_code_name == "other sweet drink" ~ "other hot drink", TRUE ~ drink_code_name)) %>% 
  mutate(drink_type_name = case_when(drink_type_name == "water" & drink_code_name == "other sweet drink" ~ "soft/flavoured beverages", TRUE ~ drink_type_name)) %>% 
  
  mutate(drink_type_name = case_when(response_id == "R_3PZZxDye0UUpQsN" & drink_code_name == "packaged fruit juice" ~ "soft/flavoured beverages", TRUE ~ drink_type_name)) %>% 
  
      mutate(drink_type_name = case_when(response_id == "R_3gUi4ebNLENyr9r" & drink_type_name == "milk drinks" & drink_code_name == "tea" ~ "hot drinks", TRUE ~ drink_type_name)) %>% 
  
    mutate(drink_type_name = case_when(drink_type_name == "water" & drink_code_name == "tea" ~ "hot drinks", TRUE ~ drink_type_name)) %>% 

 # mutate(drink_code_name = case_when(response_id == "R_D8lao1PoJ6llu7L" & drink_type_name == "soft/flavoured beverages" ~ "carbonated soft drink", TRUE ~ drink_code_name)) %>% 
  
  # likely swapped drink_code and container_code when inputting this drink for the second time
     mutate(container_code = case_when(response_id == "R_Wkdk9LaTwUmpcWJ" & drink_type_name == "soft/flavoured beverages" & drink_code_name == "water from cooler/fountain" ~ 2, TRUE ~ container_code)) %>% 
  
  mutate(drink_code_name = case_when(response_id == "R_Wkdk9LaTwUmpcWJ" & drink_type_name == "soft/flavoured beverages" & drink_code_name == "water from cooler/fountain" ~ "carbonated soft drink", TRUE ~ drink_code_name)) %>%
  
  mutate(container_code = case_when(response_id == "R_3lXJ1lkI8hbkoKT" & drink_type_name == "soft/flavoured beverages" & drink_code_name == "water from cooler/fountain" ~ 2, TRUE ~ container_code))  %>% 
  mutate(drink_code_name = case_when(response_id == "R_3lXJ1lkI8hbkoKT" & drink_type_name == "soft/flavoured beverages" & drink_code_name == "water from cooler/fountain" ~ "non-carbonated sweet drink", TRUE ~ drink_code_name))

# fixing those that have filled in "tap water" not with water as a code
clean_data <- clean_data %>% 
  mutate(container_code = case_when(response_id == "R_RmmmImdt3CiN2P7" & drink_type_name == "alcohol" & drink_code_name == "tap water" ~ 1, TRUE ~ container_code))  %>% 
  mutate(drink_code_name = case_when(response_id == "R_RmmmImdt3CiN2P7" & drink_type_name == "alcohol" & drink_code_name == "tap water" ~ "other alcoholic drinks", TRUE ~ drink_code_name)) %>% 
   mutate(drink_code_name = case_when(response_id == "R_2c2bfY9otcOtHs5" & drink_type_name == "soft/flavoured beverages" & drink_code_name == "tap water" ~ "other sweet drink", TRUE ~ drink_code_name)) %>% 
     mutate(drink_code_name = case_when(response_id == "R_27PtvkvGl0UST0G" & drink_type_name == "soft/flavoured beverages" & drink_code_name == "tap water" ~ "other sweet drink", TRUE ~ drink_code_name)) %>% 
     mutate(drink_code_name = case_when(response_id == "R_2qDF2beOQNzacaS" & drink_type_name == "soft/flavoured beverages" & drink_code_name == "tap water" ~ "other sweet drink", TRUE ~ drink_code_name)) %>% 
       mutate(drink_code_name = case_when(response_id == "R_3NwHVBI4XscNFsG" & drink_type_name == "soft/flavoured beverages" & drink_code_name == "tap water" ~ "carbonated soft drink", TRUE ~ drink_code_name)) %>% 
   mutate(drink_code_name = case_when(response_id == "R_XRn3RZGo9n2x5Jf" & drink_type_name == "soft/flavoured beverages" & drink_code_name == "tap water" ~ "other sweet drink", TRUE ~ drink_code_name)) #has filled in 1 (tap water) for each drink category 

pp_test <- clean_data %>% 
  filter(response_id == "R_2VEetDzvVxxhndG")

clean_data <- clean_data %>% 
  dplyr::mutate(drink_code_name = case_when(response_id == "R_2VEetDzvVxxhndG" & drink_code == .34 ~ "beer or cider", TRUE ~ drink_code_name)) %>% 
  dplyr::mutate(drink_code = case_when(response_id == "R_2VEetDzvVxxhndG" & drink_code == .34 ~ 34, TRUE ~ drink_code)) %>% 
  # milk drink = tap water --> changed to milk
  dplyr::mutate(drink_code_name = case_when(response_id == "R_3DbWfdOXqSTRVvk" & drink_type_name == "tap water" ~ "milk", TRUE ~ drink_code_name)) %>% 
  #drinking hot tap water? change to other hot drink
  dplyr::mutate(drink_code_name = case_when(drink_type_name == "hot drink" & drink_code_name == "tap water" ~ "other hot drink", TRUE ~ drink_code_name)) %>% 
  #ssb & tap water --> change to other sweet drink
  dplyr::mutate(drink_code_name = case_when(drink_type_name == "milk drinks" & drink_code_name == "tap water" ~ "other sweet drink", TRUE ~ drink_code_name)) 
  
# checking other vars for missing values
which(is.na(clean_data$drink_type_name)) #none
which(is.na(clean_data$amount_ml)) #none
```

## Compute amounts consumed
```{r}
# check inputs
range(clean_data$amount)

# containers: can range till 22
range(clean_data$container_code)

clean_data %>% 
  select(response_id, container_code) %>% 
  arrange(container_code) %>% 
  tail(n = 10)

# fix container codes
clean_data <- clean_data %>% 
   mutate(container_code = case_when(response_id == "R_2TF685xoaokWmY4" & container_code == 111 ~ 11, TRUE ~ container_code)) %>% 
  mutate(container_code = case_when(response_id == "R_3iE8B5M2hursNux" & container_code == 111 ~ 11, TRUE ~ container_code)) %>% 
  mutate(container_code = case_when(response_id == "R_VOMohDPBOI3I50t" & container_code == 77 ~ 11, TRUE ~ container_code)) %>% 
  mutate(container_code = case_when(response_id == "R_tQyCsr47CXZyZpv" & container_code == 30 ~ 17, TRUE ~ container_code)) 

clean_data <- clean_data %>% 
  mutate(amount_quantity = case_when(amount == 1 ~ 0.1, 
                                     amount == 2 ~ 0.25,
                                     amount == 3 ~ 0.5, 
                                     amount == 4 ~ 0.75, 
                                     amount == 5 ~ 1, 
                                     amount == 6 ~ 2, 
                                     amount == 7 ~ 3, 
                                     amount == 8 ~ 4,
                                     amount == 9 ~ 5)) %>% 
  mutate(amount_ml = case_when(container_code == 1 ~ 175*amount_quantity,
                               container_code == 2 ~ 300*amount_quantity,
                               container_code == 3 ~ 475*amount_quantity,
                               container_code == 4 ~ 220*amount_quantity,
                               container_code == 5 ~ 473*amount_quantity,
                               container_code == 6 ~ 710*amount_quantity,
                               container_code == 7 ~ 946*amount_quantity,
                               container_code == 8 ~ 350*amount_quantity,
                               container_code == 9 ~ 470*amount_quantity,
                               container_code == 10 ~ 590*amount_quantity,
                               container_code == 11 ~ 250*amount_quantity,
                               container_code == 12 ~ 200*amount_quantity,
                               container_code == 13 ~ 750*amount_quantity,
                               container_code == 14 ~ 335*amount_quantity,
                               container_code == 15 ~ 680*amount_quantity,
                               container_code == 16 ~ 330*amount_quantity,
                               container_code == 17 ~ 500*amount_quantity,
                               container_code == 18 ~ 1000*amount_quantity,
                               container_code == 19 ~ 2000*amount_quantity,
                               container_code == 20 ~ 550*amount_quantity,
                               container_code == 21 ~ 600*amount_quantity,
                               container_code == 22 ~ 1000*amount_quantity)) %>% 
  mutate(sugar_quantity = amount_sugar*amount_quantity) 
```

### Check outliers of total intake
```{r}
# calculate total fluid intake 
clean_data <- clean_data %>% 
  dplyr::group_by(pp) %>% 
  dplyr::mutate(total_fluid = sum(amount_ml)) %>% 
  dplyr::mutate(total_fluid_extra = total_fluid + soup_ml + cereal_ml)

# exclude total intake outliers (less than 0.4 L/day or higher than 6 L/day)
clean_data <- clean_data %>% 
  mutate(exclude = case_when(total_fluid_extra < 400 ~ 1,
                                    total_fluid_extra > 6000  ~ 1, 
                                    TRUE ~ 0))
       
# visualize
clean_data %>%
  dplyr::group_by(pp) %>% 
  filter(exclude == "1") %>% 
  dplyr::select(total_fluid_extra, exclude, response_id) %>% 
  distinct() %>% 
  DT::datatable(
  .,
  options = list(
    autoWidth = TRUE,
    scrollY = TRUE,
    scrollX = TRUE, 
    pageLength = 10
  ))

# save outliers to check 
outliers_amount <- clean_data %>% 
  ungroup(pp) %>% 
  filter(exclude == "1") %>% 
  dplyr::select(exclude, response_id, education) %>% 
  distinct()

# remove outliers from df
clean_data <- clean_data %>% 
  subset(!c(exclude == 1))

# bind with sick exclusions
outliers <- rbind(exclusions, outliers_amount)

# check in which SES category they are
outliers %>% 
  dplyr::count(education) %>%
  mutate(percent = n/sum(n)) 

# check SES categories of overall sample
clean_data %>% 
  dplyr::select(pp, education) %>% 
  distinct() %>% 
  dplyr::group_by("pp") %>% 
  dplyr::count(education) %>%
  mutate(percent = n/sum(n)) 

# total sample of 1117
length(unique(clean_data$pp))

# check for more problematic pp's
# e.g., participant who only reports drinking 1L of each drink each time: R_12RyUt8S02NicSL
clean_data %>% 
  ungroup() %>% 
  select(response_id, amount, drink_type_name, drink_code_name, amount_ml) %>% 
  filter(amount_ml == 2000) %>% 
  DT::datatable(
  .,
  options = list(
    autoWidth = TRUE,
    scrollY = TRUE,
    scrollX = TRUE, 
    pageLength = 10
  ))
```

## Preparing measures

```{r, warnings = FALSE}
# water intake
clean_data <- clean_data %>% 
  dplyr::group_by(pp) %>% 
  dplyr::mutate(total_water = sum(amount_ml[drink_type_name == "water"])) %>% 
  mutate(total_water_l = total_water/1000)

# ssb intake
clean_data <- clean_data %>% 
  dplyr::group_by(pp) %>% 
  dplyr::mutate(total_ssb = sum(amount_ml[drink_code_name %in% c("carbonated soft drink", "non-carbonated sweet drink", "ice tea", "other sweet drink")])) %>% 
  mutate(total_ssb_l = total_ssb/1000)

# hot drinks intake
clean_data <- clean_data %>% 
  dplyr::group_by(pp) %>% 
  dplyr::mutate(total_hot = sum(amount_ml[drink_type_name == "hot drinks"])) %>% 
  mutate(total_hot_l = total_hot/1000)

# milk drinks intake
clean_data <- clean_data %>% 
  dplyr::group_by(pp) %>% 
  dplyr::mutate(total_milk = sum(amount_ml[drink_type_name == "milk drinks"]) + cereal_ml) %>% #added milk from cereal
  mutate(total_milk_l = total_milk/1000)

# diet drinks intake
clean_data <- clean_data %>% 
  dplyr::group_by(pp) %>% 
  dplyr::mutate(total_diet = sum(amount_ml[drink_type_name == "diet beverages"])) %>% 
  mutate(total_diet_l = total_diet/1000)

# alcoholic drinks intake
clean_data <- clean_data %>% 
  dplyr::group_by(pp) %>% 
  dplyr::mutate(total_alcohol = sum(amount_ml[drink_type_name == "alcohol"])) %>% 
  mutate(total_alcohol_l = total_alcohol/1000)

# juices drink intake
clean_data <- clean_data %>% 
  dplyr::group_by(pp) %>% 
  dplyr::mutate(total_juice = sum(amount_ml[drink_code_name %in% c("packaged fruit juice", "freshly squeezed fruit juice", "fruit based smoothies", "fruit nectar", "vegetable juice")])) %>% 
  mutate(total_juice_l = total_juice/1000)

# other drink intake
clean_data <- clean_data %>% 
  dplyr::group_by(pp) %>% 
  dplyr::mutate(total_other = sum(amount_ml[drink_code_name %in% c("other drink", #the other SSBs:
                                                                   "ice coffee",
                                                                   "energy drink",
                                                                   "sports drink")]) + soup_ml) %>% #added cereal and soup to other drinks
  mutate(total_other_l = total_other/1000)

test <- clean_data %>% 
  rowwise() %>% 
  mutate(sum_tot = sum(total_water, total_ssb, total_milk, total_hot, total_alcohol, total_diet, total_juice, total_other)) %>% 
  relocate(total_fluid_extra, .after = last_col())
  
cor.test(test$total_fluid_extra, test$sum_tot) #0.999

a <- test %>% 
  select(pp, sum_tot)
b <- test %>% 
  select(pp, total_fluid_extra)

# no non-matches so good
anti_join(a, b, by="pp")

# SES
clean_data <- clean_data %>% 
  mutate(education_cat = dplyr::recode(education, "1" = "No formal qualifications",
                                "2" = "Secondary education",
                                "3" = "High school diploma/A-levels",
                                "4" = "Technical/community college",
                                "5" = "Undergraduate degree",
                                "6" = "Graduate/Doctorate degree",
                                "7" = "Graduate/Doctorate degree",
                                "8" = "NA")) %>% 
  mutate(education_cat = as.character(education_cat))

# deal with other (education = 8) category 
clean_data %>%
  ungroup() %>% 
  dplyr::filter(education == 8) %>% 
  select(response_id, education, education_8_text, age) %>% 
  unique() %>% 
  DT::datatable(
  ., 
  options = list(
    autoWidth = TRUE,
    scrollY = TRUE,
    scrollX = TRUE, 
    pageLength = 11
  ))

# some pps reported an alternative education level, here I recode them, if university was not finished, or they report having a certificate of higher education, they are assigned "High school diploma/A-levels", online diploma gets "High school diploma/A-levels"

clean_data <- clean_data %>% 
  dplyr::mutate(education_cat = case_when(response_id == "R_245xwNplbbzffsU" ~ "Technical/community college", TRUE ~ education_cat)) %>% 
  mutate(education_cat = case_when(response_id == "R_2VaOvhgIXM7V5EZ" ~ "Undergraduate degree", TRUE ~ education_cat)) %>% 
  mutate(education_cat = case_when(response_id == "R_2woy3EFPVdEvWUE" ~ "Technical/community college", TRUE ~ education_cat)) %>% 
  mutate(education_cat = case_when(response_id == "R_2YybfcOxadjzDhC" ~ "Undergraduate degree", TRUE ~ education_cat)) %>% 
  mutate(education_cat = case_when(response_id == "R_3DpPJsrWwxW67F7" ~ "Technical/community college", TRUE ~ education_cat)) %>% 
  mutate(education_cat = case_when(response_id == "R_3KIyyS7MTmYYvY9" ~ "Technical/community college", TRUE ~ education_cat)) %>% 
  mutate(education_cat = case_when(response_id == "R_5zlv0cRV71oWOAN" ~ "High school diploma/A-levels", TRUE ~ education_cat))  %>% 
  mutate(education_cat = case_when(response_id == "R_VVcwe636aDbl3Et" ~ "Technical/community college", TRUE ~ education_cat))  %>% 
  mutate(education_cat = case_when(response_id == "R_Xp1de315xG1AB69" ~ "High school diploma/A-levels", TRUE ~ education_cat))  %>% 
  mutate(education_cat = case_when(response_id == "R_245xwNplbbzffsU" ~ "Technical/community college", TRUE ~ education_cat)) %>% 
  mutate(education_cat = case_when(response_id == "R_sny3UcXg6Po9A2t" ~ "Technical/community college", TRUE ~ education_cat)) %>% 
  mutate(education_cat = case_when(response_id == "R_3nc4FGOALU4uW25" ~ "Technical/community college", TRUE ~ education_cat)) 

clean_data <- clean_data %>% 
  #filter(education_cat != "NA") %>% 
  mutate(education_cat = factor(education_cat, levels = c("No formal qualifications", "Secondary education", "High school diploma/A-levels", "Technical/community college", "Undergraduate degree", "Graduate/Doctorate degree"))) %>% 
  mutate(education_split = case_when(education_cat %in% c("No formal qualifications", "Secondary education", "High school diploma/A-levels")  ~ "low",
                                     education_cat %in% c("Technical/community college", "Undergraduate degree", "Graduate/Doctorate degree") ~ "high")) %>% 
  mutate(education_split = factor(education_split, levels = c("low", "high")))

# income: has 5 categories, Median household disposable income in the UK was 31,400 in financial year ending (FYE) 2021 (https://www.ons.gov.uk/peoplepopulationandcommunity/personalandhouseholdfinances/incomeandwealth/bulletins/householddisposableincomeandinequality/financialyearending2021)

# those who reported other/na (income = 6) category 
clean_data %>%
  ungroup() %>% 
  dplyr::filter(income == 6) %>% 
  select(response_id, education, income_6_text) %>% 
  distinct() %>% 
  DT::datatable(
  ., 
  options = list(
    autoWidth = TRUE,
    scrollY = TRUE,
    scrollX = TRUE, 
    pageLength = 10
  ))

# create var to control income for household size
range(clean_data$household_size_1_1)
range(clean_data$household_size_2_1)

clean_data <- clean_data %>% 
  dplyr::mutate(household_size = household_size_1_1 + household_size_2_1) 

# here I categorise low as <40.000 (should be 35.000; lower than 60% of median in 2023 in the UK was 35.000; National Statistics but our categories don't allow for that)
clean_data <- clean_data %>% 
  dplyr::mutate(income = case_when(income == 6 ~ NA_real_, #code those who didn't input income as NA
                                   TRUE ~ income)) %>% 
  dplyr::mutate(income_split = case_when(income <= 2 ~ "low (<40.000)",
                                     income >= 3 ~ "high (>=40.000)")) %>%
  dplyr::mutate(income_split = factor(income_split, levels = c("low (<40.000)", "high (>=40.000)"))) #to edit order

# hydration status
clean_data <- clean_data %>% 
  mutate(urine_color_r = dplyr::recode(urine_color, "1" = "8", #reverse code urine colour
                                "2" = "7", 
                                "3" = "6",
                                "4" = "5", 
                                "5" = "4", 
                                "6" = "3", 
                                "7" = "2", 
                                "8" = "1")) %>% 
  mutate(urine_color_r = as.numeric(urine_color_r)) %>% 
  #mutate(urine_color_ord = ordered(urine_color_r, levels = sort(unique(urine_color_r)))) %>% 
  mutate(urine_color_split = case_when(urine_color <= 3 ~ "adequate",
                                       urine_color >= 4 ~ "inadequate")) %>% 
  mutate(urine_color_split = factor(urine_color_split, levels = c("inadequate", "adequate")))

# hydration status: urine color
range(clean_data$urine_color, na.rm = TRUE)

# hydration status: void frequency
# 12 = "other"
clean_data %>%
  ungroup() %>% 
  dplyr::filter(void_frequency == "12") %>% 
  dplyr::select(response_id, void_frequency, void_other) %>% 
  distinct() %>% 
  DT::datatable(
  .,
  options = list(
    autoWidth = TRUE,
    scrollY = TRUE,
    scrollX = TRUE, 
    pageLength = 10
  ))

# did anyone say 0? no
range(clean_data$void_frequency)

clean_data <- clean_data %>% 
  dplyr::mutate(void_frequency = case_when(void_frequency == 12 ~ 0, TRUE ~ void_frequency)) #rename 12 ("other") as something else, 0 in this case otherwise it will clash with 12 voids
  
clean_data <- clean_data %>% 
  dplyr::mutate(void_frequency = case_when(response_id == "R_10ximB7QgNhHGcw" ~ 12, TRUE ~ void_frequency)) %>% 
  dplyr::mutate(void_frequency = case_when(response_id == "R_1dAImaTEWni8Jpm" ~ NA_real_, TRUE ~ void_frequency)) %>% 
  dplyr::mutate(void_frequency = case_when(response_id == "R_1gqnjuD8HUx1oFG" ~ 20, TRUE ~ void_frequency)) %>% 
  dplyr::mutate(void_frequency = case_when(response_id == "R_21bkryFichHICPS" ~ NA_real_, TRUE ~ void_frequency)) %>% 
  dplyr::mutate(void_frequency = case_when(response_id == "R_21zIv2Sn1C8zYrY" ~ 20, TRUE ~ void_frequency)) %>% 
  dplyr::mutate(void_frequency = case_when(response_id == "R_2AStSnddZeP2JJ1" ~ 12, TRUE ~ void_frequency)) %>% 
  dplyr::mutate(void_frequency = case_when(response_id == "R_2cuTlKMLnlEMPmJ" ~ NA_real_, TRUE ~ void_frequency)) %>% 
  dplyr::mutate(void_frequency = case_when(response_id == "R_2TBhWKac2DK91Xt" ~ NA_real_, TRUE ~ void_frequency)) %>% 
  dplyr::mutate(void_frequency = case_when(response_id == "R_300pNYaJanNxIJe" ~ 13, TRUE ~ void_frequency)) %>% 
  dplyr::mutate(void_frequency = case_when(response_id == "R_3m8prsPyqIgcBff" ~ 14, TRUE ~ void_frequency)) %>% 
  dplyr::mutate(void_frequency = case_when(response_id == "R_3NwHVBI4XscNFsG" ~ 14, TRUE ~ void_frequency)) %>% 
  dplyr::mutate(void_frequency = case_when(response_id == "R_3pgPe5uDOBcZFHH" ~ NA_real_, TRUE ~ void_frequency))  %>% 
  dplyr::mutate(void_frequency = case_when(response_id == "R_yJdijv0Q8fUQ7Pb" ~ NA_real_, TRUE ~ void_frequency)) %>% 
  dplyr::mutate(void_frequency = case_when(response_id == "R_1MKmfBO39gj3qy5" ~ NA_real_, TRUE ~ void_frequency)) 

# code outliers (20) as NA
clean_data <- clean_data %>% 
  dplyr::mutate(void_frequency = case_when(void_frequency == 20 ~ NA_real_, TRUE ~ void_frequency)) %>% 
  mutate(void_frequency = as.numeric(void_frequency)) %>% 
  mutate(void_frequency_split = case_when(void_frequency < 7 ~ "inadequate",
                                       void_frequency >= 7 ~ "adequate")) %>% 
  mutate(void_frequency_split = factor(void_frequency_split, levels = c("inadequate", "adequate")))
```

### Preparing rest of measures
```{r}
# control vars
clean_data <- clean_data %>% 
  mutate(control = case_when(control == 0 ~ "no",
                             control == 1 ~ "yes")) %>% 
  mutate(control = factor(control, levels = c("no", "yes")))

# color blindness
clean_data <- clean_data %>% 
  mutate(color_blind = dplyr::recode(color_blind, "1" = "no",
                              "2" = "yes")) %>% 
  mutate(color_blind = factor(color_blind, levels = c("no", "yes")))

# physical activity
clean_data <- clean_data %>% 
  mutate_at(vars(ipaq_number_1_1_1:ipaq_number_1_3_1),
            list(~as.numeric(.))) %>% 
  mutate(MET_PA = 3.3*ipaq_number_1_3_1 + 4*ipaq_number_1_2_1 +
           8*ipaq_number_1_1_1, na.rm = TRUE)

range(clean_data$MET_PA, na.rm = TRUE)

clean_data %>% 
  ungroup() %>% 
  dplyr::select(response_id, ipaq_number_1_1_1, ipaq_number_1_2_1, ipaq_number_1_3_1, MET_PA) %>% 
  arrange(MET_PA) %>% 
  dplyr::filter(!is.na(MET_PA)) %>% 
  distinct() %>% 
  tail(n = 20)

# clean impossible answers
clean_data <- clean_data %>% 
  mutate(ipaq_number_1_3_1 = case_when(response_id == "R_2ck0gd9saY1Guqm" ~ 150,
                                       TRUE ~ ipaq_number_1_3_1)) #change 25 hours of walking to 2.5

# recalculate again
clean_data <- clean_data %>% 
  mutate_at(vars(ipaq_number_1_1_1:ipaq_number_1_3_1),
            list(~as.numeric(.))) %>% 
  mutate(MET_PA = 3.3*ipaq_number_1_3_1 + 4*ipaq_number_1_2_1 + 
           8*ipaq_number_1_1_1)

plot <- geom_plot(clean_data, MET_PA, "physical activity")
plot

# alternative PA measure?
# average moderate-intense activity on that day
clean_data <- clean_data %>% 
  mutate(PA_day = ipaq_number_1_2_1 + ipaq_number_1_1_1)

# gender
clean_data <- clean_data %>% 
  mutate(gender = dplyr::recode(
      gender,
      "1" = "male",
      "2" = "female",
      "3" = "non-binary/other"
  )) %>% 
  mutate(gender = as.factor(gender))

# age
range(clean_data$age)
which(clean_data$age==465) #465 impossible age

pp_test <- clean_data %>% 
  filter(response_id == clean_data[366,]$response_id) 

clean_data <- clean_data %>% 
  mutate(age = case_when(response_id == "R_2pRax2EoGN6P5FK" ~ 45,
                         TRUE ~ age)) #pp is 45 in prolific records

range(clean_data$age)

clean_data <- clean_data %>% 
  dplyr::mutate(age_cat = case_when(between(age, 18, 34) ~
                                      "18-34", 
                                    between(age, 35, 54) ~
                                      "35-54",
                                    between(age, 55, 85) ~
                                      "55-85"))

describe(clean_data$age)

# proportions
clean_data %>% 
  group_by(age_cat) %>% 
  dplyr::count(age_cat) %>%
  ungroup() %>% 
  mutate(percent = n/sum(n)) 

# location
clean_data <- clean_data %>% 
  mutate(location = dplyr::recode(
      location,
      "1" = "England",
      "2" = "Scotland",
      "3" = "Wales",
      "4" = "Northern Ireland",
      "5" = "Other"
  )) %>% 
  mutate(location = as.character(location))

# proportions
clean_data %>% 
  group_by(location) %>% 
  dplyr::count(location) %>%
  ungroup() %>% 
  dplyr::mutate(percent = n/sum(n)) 

# fluid intake
range(clean_data$total_fluid_extra, na.rm = TRUE)
plot <- geom_plot(clean_data, total_fluid_extra, "total_fluid_extra")
plot

clean_data <- clean_data %>% 
  arrange(total_fluid_extra) 

head(clean_data$total_fluid_extra, n = 10)
tail(clean_data$total_fluid_extra, n = 10) 

# look for outliers
clean_data %>% 
  ggplot(aes(y = total_fluid_extra)) + geom_boxplot(outlier.colour="black")

out <- boxplot.stats(clean_data$total_fluid_extra)$out
# which rows are outliers
out_ind <- which(clean_data$total_fluid_extra %in% c(out))
out_ind
# which subjects does this correspond to
outliers1 = clean_data[out_ind,]$response_id
outliers1

# save file without outliers and rerun analyses in this file 
clean_data_wide_outliers <- clean_data %>% 
  filter(!response_id %in% c(outliers1)) 

# total fluid in L
clean_data <- clean_data %>% 
  mutate(total_fluid_extra_l = total_fluid_extra/1000)

# water intake outliers
# total_water is not at all linearly distributed because of the amount of pp drinking 0 water
plot <- geom_plot(clean_data, total_water, "total water")
plot

#check for outliers
clean_data <- clean_data %>% 
  arrange(total_water) 

head(clean_data$total_water, n = 10)
tail(clean_data$total_water, n = 10) 

# look for outliers
clean_data %>% 
  ggplot(aes(y = total_water)) + geom_boxplot(outlier.colour="black")

out <- boxplot.stats(clean_data$total_water)$out
# which rows are outliers
out_ind <- which(clean_data$total_water %in% c(out))
out_ind
# which subjects does this correspond to
outliers_water = clean_data[out_ind,]$response_id
outliers_water

# removing these does not change much about the mean amount of water consumed (-90ml)
clean_data %>% 
  ungroup() %>% 
  dplyr::summarize(mean(total_water))

clean_data %>% 
  ungroup() %>% 
  filter(response_id %ni% c(outliers_water)) %>% 
  dplyr::summarize(mean(total_water))

# ssb outliers
plot <- geom_plot(clean_data, total_ssb, "total ssb")
plot
```

### Beverage liking
```{r}
clean_data <- clean_data %>% 
  mutate(water_liking = mean(c(liking_1, liking_2, liking_3, liking_4, liking_5, liking_6), na.rm = TRUE)) %>% 
  mutate(ssb_liking = mean(c(liking_7, liking_8, liking_9, liking_11), na.rm = TRUE))

# ice coffee is not included because it's not included in our calculations of total ssb intake
```

### Fruits and vegetables
```{r}
# sum up all portions except potatoes
clean_data <- clean_data %>% 
  mutate(fv_portions = f_v_number_1_1 + f_v_number_1_2 + f_v_number_1_3 + 
           f_v_number_1_4 + f_v_number_1_6 + f_v_number_1_7 +  f_v_number_1_8 + f_v_number_1_9 + f_v_number_1_10)

# add a portion a day for those pp who reported having a fruit or vegetable drink

juice_pp <- clean_data %>% 
  ungroup() %>% 
  filter(drink_code_name %in% c("freshly squeezed fruit juice",
                                "fruit based smoothies",
                                "vegetable juice")) %>% 
  select(response_id) %>% 
  unique() %>% #only one portion extra per participant
  unlist()

# add an extra portion of F&V for these pp
clean_data$FV_portions <- NA

for (i in 1:nrow(clean_data)) {
if(clean_data$response_id[i] %in% c(juice_pp)
)
  {clean_data$FV_portions[i] = clean_data$fv_portions[i]+1
}
  else{clean_data$FV_portions[i] = clean_data$fv_portions[i]
}
}

clean_data <- clean_data %>% 
  mutate(portions_five_a_day = case_when(FV_portions >= 5 ~ 1,
                                         TRUE ~ 0))
```

### Control variables

```{r}
clean_data <- clean_data %>% 
  mutate(disease = case_when(exclusions_4 == 1 ~ "yes",
                             exclusions_4 == 0 ~ "no")) %>% 
  mutate(disease = factor(disease)) %>% 
  mutate(medication = case_when(exclusions_2 == 1 ~ "yes",
                             exclusions_2 == 0 ~ "no")) %>% 
    mutate(medication = factor(medication)) %>% 
    mutate(hypertensive = case_when(exclusions_3 == 1 ~ "yes",
                             exclusions_3 == 0 ~ "no")) %>% 
    mutate(hypertensive = factor(hypertensive)) %>% 
    mutate(menstruation = case_when(exclusions_5 == 1 ~ "yes",
                             exclusions_5 == 0 ~ "no")) %>% 
    mutate(menstruation = factor(menstruation)) %>% 
    mutate(menstruation = dplyr::recode(menstruation, levels = c("no", "yes"))) %>% 
    mutate(pregnant_lactating = case_when(exclusions_6 == 1 ~ "yes",
                             exclusions_6 == 0 ~ "no")) %>% 
    mutate(pregnant_lactating = factor(pregnant_lactating)) %>% 
    mutate(high_protein_caloric = case_when(exclusions_7 == 1 ~ "yes",
                             exclusions_7 == 0 ~ "no")) %>% 
    mutate(high_protein_caloric = factor(high_protein_caloric))

# remove control var if no one has said "yes"
"yes" %in% clean_data$disease
"yes" %in% clean_data$medication
"yes" %in% clean_data$hypertensive
"yes" %in% clean_data$menstruation
"yes" %in% clean_data$pregnant_lactating
"yes" %in% clean_data$high_protein_caloric

# remove disease control var
clean_data <- clean_data %>% 
  select(-c("disease"))

# sugar intake
clean_data <- clean_data %>% 
  dplyr::group_by(pp) %>% 
  dplyr::mutate(total_sugar = sum(sugar_quantity))
```

```{r}
# remove unnecessary columns
clean_data <- clean_data %>% 
  dplyr::select(-c(household_size_1_1, 
                   household_size_2_1, 
                   evening_no_drink,
                   urine_color,
                   void_other,
                   liking_1:liking_11,
                   f_v_number_1_1:f_v_number_1_10,
                   ipaq_number_1_1_1:ipaq_number_1_3_1,
                   exclusions_1:exclusions_10_text,
                   education_8_text,
                   income_6_text,
                   errors,
                   comments,
                   height_unit:weight_other))

clean_data_long <- clean_data

# save file
save(clean_data_long, file = "clean_data_long.Rdata")

# save open answers
clean_data_open <- clean_data %>% 
  select(c(response_id, color_drink, color_health, color_own, chart_prior, urine_color_health)) %>% 
  distinct() 

save(clean_data_open, file = "clean_data_open.Rdata")
write.csv(clean_data_open,"clean_data_open.csv", row.names = FALSE)
```

## Create wide format

We calculated the sum of all drink categories and here create a file that has 1 row per participant. 

```{r}
clean_data_wide <- clean_data %>% 
  select(-c(time_drink:sugar_quantity)) %>% 
  distinct() 

save(clean_data_wide, file = "clean_data_wide.Rdata")
```

# Variable descriptives
## Participants and SES
```{r}
# characteristics per SES group
tbl_descr <- clean_data_wide %>% 
  group_by(education_cat) %>% 
  dplyr::select(education_cat, age_cat, gender, income_split, urine_color_split, total_fluid_extra_l, total_water_l, total_ssb_l, #FV_portions, 
         BMI, PA_day) %>%
  #filter(income_split %ni% NA_real_) %>% 
  tbl_summary(by = "education_cat",
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{n} ({p}%)"),
              label = 
                c(age_cat ~ "Age", 
                  gender ~ "Gender", 
                  income_split ~ "Income",
                  urine_color_split ~ "Hydration status (urine colour)",
                  total_fluid_extra_l ~ "Total fluid intake (L)",
                  total_water_l ~ "Total water intake (L)",
                  total_ssb_l ~ "Total SSB intake (L)",
                  PA_day ~ "Moderate-intense physical activity (min)")) %>% 
  add_overall()

tbl_descr

# Convert to gt object
gt_tbl <- as_gt(tbl_descr)

# Write to Word
gtsave(gt_tbl, "tbl_descr_ex1.docx")

plot <- ggplot(clean_data_wide, aes(income, fill = income_split)) +
  geom_bar()
plot

plot <- ggplot(clean_data_wide, aes(education_cat, fill = education_split)) +
  geom_bar()
plot

# descriptives table only for low vs. high education
tbl_descr_1 <- clean_data_wide %>% 
  group_by(education_split) %>% 
  dplyr::select(education_split, age_cat, gender, income_split, urine_color_split, total_fluid_extra_l, total_water_l, total_ssb_l, #FV_portions, 
         BMI, PA_day) %>%
  #filter(income_split %ni% NA_real_) %>% 
  tbl_summary(by = "education_split",
              statistic = list(all_continuous() ~ "{mean} ({sd})",
                     all_categorical() ~ "{n} ({p}%)"),
              label = 
                c(age_cat ~ "Age", 
                  gender ~ "Gender", 
                  income_split ~ "Income",
                  urine_color_split ~ "Hydration status (urine colour)",
                  total_fluid_extra_l ~ "Total fluid intake (L)",
                  total_water_l ~ "Total water intake (L)",
                  total_ssb_l ~ "Total SSB intake (L)",
                  PA_day ~ "Moderate-intense physical activity (min)")) %>% 
  add_overall()

tbl_descr_1

# Convert to gt object
gt_tbl_1 <- as_gt(tbl_descr)

# Write to Word
gtsave(gt_tbl, "tbl_descr_ex1_1.docx")
```


## Fluid intake
```{r}
# total fluid intake
plot <- geom_plot(clean_data_wide, total_fluid_extra, "total fluid")
plot

# select colors
pal <- drygatebrewer::drygate_palette("TakeMeTotheRiver")

# scale y-axis
scaleFUN <- scaleFUN <- function(x) sprintf("%.2f", x)

#very few non-binary/other so removing for analyses
ggplot(subset(clean_data_wide, gender %in% c("male", "female")), aes(x=total_fluid_extra/1000, color=gender, fill = gender)) + 
  geom_histogram(alpha=0.5, position="identity") +
  geom_vline(xintercept = 2, linetype = "dashed", linewidth = 1, color = pal[1]) + 
  geom_vline(xintercept = 2.5, linetype = "dashed", linewidth = 1, color =pal[3]) +
  scale_x_continuous(labels=scaleFUN) + 
  xlab("Total fluid intake (L)") +
  scale_color_manual(values = pal[c(1,3)]) +
  scale_fill_manual(values = pal[c(1,3)]) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(color = 'black'),
        #axis.ticks.y=element_blank(),
        #axis.ticks.x=element_blank(), 
        #legend.position="none",
        legend.title = element_blank(),
        legend.text = element_text(size=12),
        axis.text.x=element_text(size=12, colour = "black"),
        axis.text.y=element_text(size=12, colour = "black"),
        axis.title.x=element_text(size=12),
        axis.title.y=element_text(size=12)
        )

# average per gender
clean_data_wide %>% 
  group_by(gender) %>% 
  select(total_fluid_extra) %>% 
  dplyr::summarize(av = mean(total_fluid_extra), 
                   sd = sd(total_fluid_extra))

# females who do drink >2L a day
clean_data_wide %>% 
  group_by(gender) %>% 
  select(total_fluid_extra) %>% 
  dplyr::count(total_fluid_extra >= 2000) %>%
  dplyr::mutate(percent = n/sum(n))

# men who drank >2.5L a day
clean_data_wide %>% 
  group_by(gender) %>% 
  select(total_fluid_extra) %>% 
  dplyr::count(total_fluid_extra >= 2500) %>%
  dplyr::mutate(percent = n/sum(n))
```

## Stacked bar graph (intake per drink type)

```{r}
mean(clean_data_wide$total_fluid_extra, na.rm = TRUE) #mean total fluid
mean(clean_data_long$amount_ml, na.rm = TRUE) #mean amount per drinking instance
mean(clean_data_wide$total_water, na.rm = TRUE) #mean water per sample

# with wide format
total_means <- clean_data_wide %>%
  dplyr::filter(gender %in% c("male", "female")) %>% 
  dplyr::group_by(gender) %>% 
  dplyr::summarize(across(c("total_water", "total_ssb", "total_other",
                            "total_milk", "total_hot", "total_diet",
                            "total_alcohol"), mean)) %>% 
  as.data.frame()

# transform to long format
total_means <- gather(total_means, drink_type_name, amount_ml, total_water:total_alcohol)

pal <- drygate_palette(10, name = "TakeMeTotheRiver", type = "continuous")
pal <- pal[-c(6, 8, 10)] #remove white and in-between color

total_means <- total_means %>% 
  mutate(drink_type_name = factor(drink_type_name, levels = 
                                    c("total_other", 
                                      "total_alcohol",
                                      "total_diet",
                                      "total_milk",
                                      "total_ssb", 
                                      "total_hot",
                                      "total_water")))

# mean per drink type compared to total mean
figure2 <- ggplot(total_means,
       aes(x = gender,
           y = amount_ml,
           fill = drink_type_name)) + 
  geom_bar(stat = "identity") +
  scale_fill_manual(values = pal, labels = c("total_water" = "water", "total_ssb" = "SSBs", "total_other" = "other", "total_milk" = "milk drinks",
                                  "total_hot" = "hot drinks", 
                                  "total_diet" = "diet beverages",
                                 "total_alcohol" = "alcohol")) + 
  scale_x_discrete(labels = c("Female", "Male")) +
  
  theme(
    panel.border = element_rect(colour = "black", fill = NA, size = 1), #to create a border
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    axis.text.y=element_text(size=12, color="black"),
    axis.title.x=element_blank(),
    axis.text.x=element_text(size=12, color='black', face = "bold"),
    axis.title.y=element_text(size=12, color='black', face = "bold"),
    axis.ticks.y=element_blank(),
    axis.ticks.x=element_blank(),
    legend.title=element_text(size=12, color='black', face = "bold"),
    legend.text=element_text(size=12)) + ylab("Mean consumption (ml)") + labs(fill = "Drink Type")
  #labs(title = "Beverage intake per gender and drink type (mean ml)", #subtitle = "Average consumption (ml)") 
figure2

#ggsave(figure2, file= "figure2.png", width = 10, height = 8)

# popularity of beverages
total_pop <- clean_data_wide %>%
  ungroup() %>% 
  dplyr::summarize(water_percentage = mean(total_water > 0)*100,
                   ssb_pct = mean(total_ssb > 0)*100,
                   other_percentage = mean(total_other > 0)*100,
                   milk_percentage = mean(total_milk > 0)*100,
                   hot_percentage = mean(total_hot > 0)*100,
                   diet_pct = mean(total_diet > 0)*100,
                   alcohol_pct = mean(total_alcohol > 0)*100) %>% 
  as.data.frame()
total_pop

# by gender
total_pop_gender <- clean_data_wide %>%
  filter(gender %in% c("male", "female")) %>% 
  group_by(gender) %>% 
  dplyr::summarize(water_percentage = mean(total_water > 0)*100,
                   ssb_pct = mean(total_ssb > 0)*100,
                   other_percentage = mean(total_other > 0)*100,
                   milk_percentage = mean(total_milk > 0)*100,
                   hot_percentage = mean(total_hot > 0)*100,
                   diet_pct = mean(total_diet > 0)*100,
                   alcohol_pct = mean(total_alcohol > 0)*100) %>% 
  as.data.frame()

# transform to long format
total_pop_gender <- gather(total_pop_gender, drink_type_name, percentage, water_percentage:alcohol_pct)

pal <- drygate_palettes$TakeMeTotheRiver[c(1, 3)]

figure2_extra <- ggplot(total_pop_gender,
       aes(x = drink_type_name,
           y = percentage,
           fill = gender)) + 
  geom_bar(alpha=0.8, stat = "identity", position = "dodge") +
  scale_x_discrete(limits = rev, labels = c("water_percentage" = "water", "ssb_pct" = "SSBs", "other_percentage" = "other", "milk_percentage" = "milk drinks",
                                  "hot_percentage" = "hot drinks", 
                                  "diet_pct" = "diet beverages",
                                 "alcohol_pct" = "alcohol")) + 
  scale_y_continuous(limits = c(0, 100)) +
  scale_fill_manual(values = pal, labels = c("Female", "Male")) +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, size = 1), #to create a border
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    axis.text.y=element_text(size=12, color="black"),
    axis.title.x=element_blank(),
    axis.text.x=element_text(size=12, color='black', angle = 45, hjust = 1),
    axis.title.y=element_text(size=12, color='black', face = "bold"),
    axis.ticks.y=element_blank(),
    axis.ticks.x=element_blank(),
    legend.title=element_text(size=12, color='black', face = "bold"),
    legend.text=element_text(size=12)) + ylab("% consuming") + labs(fill = "Gender")
figure2_extra

#ggsave(figure2_extra, file= "figure2_extra.png", width = 10, height = 8)

total_means <- total_means %>% 
  mutate(drink_type_name = factor(drink_type_name, levels = 
                                    c("total_other", 
                                      "total_alcohol",
                                      "total_diet",
                                      "total_milk",
                                      "total_ssb", 
                                      "total_hot",
                                      "total_water")))
```

## Fig. 2B
```{r}
pal <- drygate_palette(10, name = "TakeMeTotheRiver", type = "continuous")
pal <- pal[-c(6, 8, 10)] #remove white and in-between color

figure_B <- ggplot(total_means,
                   aes(x = gender,
                       y = amount_ml,
                       fill = drink_type_name)) +
  geom_col(position = "stack", width = 0.8, alpha = 1) +
  scale_fill_manual(
    values = pal,
    labels = c("total_water" = "water",
               "total_ssb"   = "SSBs",
               "total_other" = "other",
               "total_milk"  = "milk drinks",
               "total_hot"   = "hot drinks",
               "total_diet"  = "diet beverages",
               "total_alcohol" = "alcohol")) +
  scale_x_discrete(limits = c("male", "female"),
                   labels = c("male" = "Male", "female" = "Female")) +
  #xlab("Mean consumption (ml)") +
  labs(fill = "Drink Type") +
  coord_flip() +   # rotate 90 degrees
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill = NA, size = 1),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    #axis.text.x = element_text(size = 12),
    #axis.text.x = element_text(size = 12),
    #axis.title.y = element_text(size = 12, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 9),
    legend.position = "top",
    plot.title = element_text(size=12, colour = "black")) +
guides(fill = guide_legend(nrow = 1, byrow = TRUE, reverse = TRUE)) +
  ggtitle("Gender and consumption")
  
figure_B
```

```{r}
# total water intake
data_water <- clean_data %>%
  dplyr::filter(drink_type_name == "water")

clean_data_wide %>% 
  ungroup() %>% 
  dplyr::summarize(mean(total_water),
                   sd(total_water))

# mean fluid for each drink type
clean_data_wide %>% 
  ungroup() %>% 
  dplyr::summarize(mean_water = mean(total_water),
                   mean_ssb = mean(total_ssb),
                   mean_milk = mean(total_milk),
                   mean_hot = mean(total_hot),
                   mean_alcohol = mean(total_alcohol),
                   mean_diet = mean(total_diet),
                   mean_juice = mean(total_juice),
                   mean_other = mean(total_other)) 

# % of total fluid of each drink type
clean_data_wide %>% 
   ungroup() %>% 
   dplyr::summarize(pct_water = mean(total_water/total_fluid_extra),
             pct_ssb = mean(total_ssb/total_fluid_extra),
             pct_milk = mean(total_milk/total_fluid_extra),
             pct_hot = mean(total_hot/total_fluid_extra),
             pct_alcohol = mean(total_alcohol/total_fluid_extra),
             pct_diet = mean(total_diet/total_fluid_extra),
             pct_juice = mean(total_juice/total_fluid_extra),
             pct_other = mean(total_other/total_fluid_extra))

# pp who do not drink any water? 16%
clean_data_wide %>% 
  ungroup() %>% 
  select(total_water) %>% 
  dplyr::count(total_water == 0) %>%
  dplyr::mutate(percent = n/sum(n))
# pp who drank <1 liter of water = 637 = 57%
clean_data_wide %>% 
  ungroup() %>% 
  select(total_water) %>% 
  dplyr::count(total_water < 1000) %>%
  dplyr::mutate(percent = n/sum(n))
# pp who drank 1-2 liter of water = 297 = 27%
clean_data_wide %>% 
  ungroup() %>% 
  select(total_water) %>% 
  dplyr::count(between(total_water, 1000, 2000)) %>%
  dplyr::mutate(percent = n/sum(n))
# pp who drank > 2 liter of water = 183 = 16%
clean_data_wide %>% 
  ungroup() %>% 
  select(total_water) %>% 
  dplyr::count(total_water > 2000) %>%
  dplyr::mutate(percent = n/sum(n))

library(Rmisc)
water_means <- summarySE(data_water, measurevar="amount_ml", groupvars=c("drink_code_name"), na.rm = TRUE)
water_means 

water_means <- water_means %>% 
 mutate(total_amount = amount_ml*N) %>% 
  mutate(pct = total_amount/(sum(total_amount))) %>% 
  mutate(drink_code_name = factor(drink_code_name, levels = c("tap water",
                                                              "water from cooler/fountain",
                                                              "carbonated bottled water",
                                                              "non-carbonated bottled water",
                                                              "flavoured carbonated bottled water",
                                                              "flavoured non-carbonated bottled water")))

pal <- drygate_palette("TakeMeTotheRiver")

ggplot(water_means,
       aes(x = fct_reorder(drink_code_name, pct),
           y = pct,
           fill = drink_code_name,
           label = paste0(sprintf("%0.1f", round(pct*100, digits = 1)), "%"))) + coord_flip() + 
  geom_col(position = "dodge", alpha = 0.8) +  
  # scale_fill_viridis_d() +
  geom_text(hjust = -0.1) + 
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) + 
  scale_fill_manual(values = c("#792149", 
                               "#34b77b", "#c0d73d", "#ed347e", 
                               "#cfd0d2", "#fcd92c")) +
  #xlab("Drink percentage among water drinks") +
  theme(
    panel.border = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text.y=element_text(size=12, colour = "black"),
    axis.ticks.y=element_blank(),
    axis.ticks.x=element_blank(), 
    legend.title=element_blank(),
    legend.position = "none",
    axis.text.x=element_blank(),
    axis.title.x=element_blank(),
    axis.title.y=element_blank()
    ) 

# total ssb intake
data_ssb <- clean_data %>% 
  dplyr::group_by(pp) %>% 
  filter(drink_code_name %in% c("carbonated soft drink", "non-carbonated sweet drink", "ice tea", "other sweet drink"))

# mean total ssb
mean(clean_data_wide$total_ssb)

# pp who do not drink any ssb? 66%
clean_data_wide %>% 
  ungroup() %>% 
  select(total_ssb) %>% 
  dplyr::count(total_ssb == 0) %>%
  dplyr::mutate(percent = n/sum(n))
# pp who drank 1-500 liter of ssb = 18%
clean_data_wide %>% 
  ungroup() %>% 
  select(total_ssb) %>% 
  dplyr::count(between(total_ssb, 1, 500)) %>%
  dplyr::mutate(percent = n/sum(n))
# pp who drank more than 1 liter per day (1%)
clean_data_wide %>% 
  ungroup() %>% 
  select(total_ssb) %>% 
  dplyr::count(total_ssb > 1000) %>%
  dplyr::mutate(percent = n/sum(n))

ssb_means <- summarySE(data_ssb, measurevar="amount_ml", groupvars=c("drink_code_name"), na.rm = TRUE)
ssb_means 

ssb_means <- ssb_means%>% 
  mutate(total_amount = amount_ml*N) %>% 
  mutate(pct = total_amount/(sum(total_amount))) %>% 
  mutate(drink_code_name = factor(drink_code_name, levels = c("carbonated soft drink", 
                                                              "non-carbonated sweet drink",
                                                              "ice tea",
                                                              "other sweet drink")))

ggplot(ssb_means,
       aes(x = fct_reorder(drink_code_name, pct),
           y = pct,
           fill = drink_code_name,
           label = paste0(sprintf("%0.1f", round(pct*100, digits = 1)), "%"))) + coord_flip() + 
  geom_col(position = "dodge", alpha = 0.8) +  
  # scale_fill_viridis_d() +
  geom_text(hjust = -0.1) + 
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) + 
  scale_fill_manual(values = c("#792149", 
                               "#34b77b", "#c0d73d", "#ed347e", 
                               "#cfd0d2", "#fcd92c")) +
  #xlab("Drink percentage among SSBs") +
  theme(
    panel.border = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_blank(), 
    panel.grid.minor = element_blank(),
    axis.text.y=element_text(size=12, colour = "black"),
    axis.ticks.y=element_blank(),
    axis.ticks.x=element_blank(), 
    legend.title=element_blank(),
    legend.position = "none",
    axis.text.x=element_blank(),
    axis.title.x=element_blank(),
    axis.title.y=element_blank()
    ) 
```

## Hydration status
```{r}
# hydration status - urine color
# select colors
pal <- drygatebrewer::drygate_palette("TakeMeTotheRiver")

# replace urine color levels with images
clean_data_wide <- clean_data_wide %>% 
  mutate(urine_color_r_fac = factor(urine_color_r)) %>% 
  mutate(urine_color_r_fac = dplyr::recode(urine_color_r_fac,
                                    "1" = "one", 
                                    "2" = "two",
                                    "3" = "three", 
                                    "4" = "four",
                                    "5" = "five",
                                    "6" = "six",
                                    "7" = "seven",
                                    "8" = "eight")) %>% 
  mutate(urine_color_r_fac = fct_relevel(urine_color_r_fac, c("one",
                                           "two",
                                           "three",
                                           "four",
                                           "five",
                                           "six",
                                           "seven",
                                           "eight")))

# define urine color images as labels
labels <- c(
  one = "<img src='urine_8.jpg'
  width='35' height = '25' /><br>",
  two = "<img src='urine_7.jpg'
  width='35' height = '25' /><br>",
  three = "<img src='urine_6.jpg'
  width='35' height = '25' /><br>",
  four = "<img src='urine_5.jpg'
  width='35' height = '25' /><br>",
  five = "<img src='urine_4.jpg'
  width='35' height = '25' /><br>",
  six = "<img src='urine_3.jpg'
  width='35' height = '25' /><br>",
  seven = "<img src='urine_2.jpg'
  width='35' height = '25' /><br>",
  eight = "<img src='urine_1.jpg'
  width='35' height = '25' /><br>"
  )
```

## Fig. 2A
```{r}
figure_A <- ggplot(
  data = subset(clean_data_wide, gender %in% c("male", "female")),
  aes(x = urine_color_r_fac, 
      y = ..count..,
      fill = urine_color_split,
      pattern = gender)) +
  geom_bar_pattern(position = position_dodge(width = 1),
                   color = "black",
                   pattern_fill = "black",
                   pattern_angle = 45,
                   pattern_density = 0.1,
                   alpha = 1) +
  scale_fill_manual(values = pal[c(1,3)]) +
  guides(
    fill = guide_legend(order = 2, title = "Hydration",
                        override.aes = list(pattern = "none")),  # <--- no pattern here
    pattern = guide_legend(order = 1, title = "Gender",
                           override.aes = list(
                             fill = c("white"),         # neutral bg
                             pattern = c("circle","none"),
                             pattern_fill = c(NA,"black"),
                             pattern_colour = c("black","black"),
                             colour = c("black","black")
                           ))
  ) +
  labs(x = "Urine Colour", y = "Frequency", 
       fill = "Hydration", pattern = "Gender") +
  scale_pattern_manual(values = c("male" = "none", "female" = "circle")) +
  scale_x_discrete(labels = labels) +
  theme(axis.text.x = ggtext::element_markdown()) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        #panel.border = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(color = 'black'),
        legend.title = element_blank(),
        legend.text = element_text(size=9),
        axis.text.y = element_text(size=12, colour = "black"),
        axis.title.x = element_text(size=12, colour = "black", face = "bold"),
        axis.title.y = element_text(size=12, colour = "black", face = "bold"),
        legend.position = "top", 
        plot.title = element_text(size=12, colour = "black")) + 
  ggtitle('Gender and hydration status')
figure_A

# # alternative version
# figure_A_alt <- ggplot(
#   data = subset(clean_data_wide, gender %in% c("male", "female")),
#   aes(x = urine_color_r_fac, 
#       fill = urine_color_split)) +
#   geom_bar(position = "stack", color = "black", alpha = 0.8) +
#   scale_fill_manual(values = pal[c(1,3)]) +
#   labs(x = "Urine Colour", y = "Frequency", fill = "Hydration") +
#   scale_x_discrete(labels = labels) +
#   facet_wrap(~ gender, ncol = 1) +
#   theme_minimal() +
#   theme(axis.text.x = ggtext::element_markdown(),
#         panel.grid.major = element_blank(),
#         panel.grid.minor = element_blank(),
#         axis.title.x = element_text(size = 12, face = "bold"),
#         axis.title.y = element_text(size = 12, face = "bold"),
#         legend.position = "top", 
#         legend.title = element_blank(),
#         plot.title = element_text(size=12, colour = "black")) + 
#   ggtitle('Gender and hydration status')
# figure_A_alt
```

```{r}
# 60% was adequately hydrated
clean_data_wide %>% 
  ungroup() %>% 
  select(urine_color_split) %>% 
  dplyr::count(urine_color_split == "adequate") %>%
  dplyr::mutate(percent = n/sum(n))

# by gender
clean_data_wide %>% 
  group_by(gender) %>% 
  select(urine_color_split) %>% 
  dplyr::count(urine_color_split == "adequate") %>%
  dplyr::mutate(percent = n/sum(n))

# % of color for those who are inadequately hydrated
clean_data_wide %>% 
  filter(urine_color_split == "inadequate") %>% 
  dplyr::group_by(urine_color_r) %>% 
  dplyr::count(urine_color_r) %>%
  ungroup() %>% 
  dplyr::mutate(percent = n/sum(n))

# % of color for euhydrated, underhydrated, and dehydrated
clean_data_wide %>% 
  mutate(urine_three = case_when(urine_color_r %in% c(6, 7, 8) ~ "euhydrated",
                                 urine_color_r %in% c(4, 5) ~ "underhydrated",
                                 urine_color_r %in% c(1, 2, 3) ~ "dehydrated",
                                 is.na(urine_color_r) ~ NA_character_ 
  )) %>% 
  dplyr::group_by(urine_three) %>% 
  dplyr::count(urine_three) %>%
  ungroup() %>% 
  dplyr::mutate(percent = n/sum(n))

# male
clean_data_wide %>% 
  filter(urine_color_split == "inadequate" & gender == "male") %>% 
  dplyr::group_by(urine_color_r) %>% 
  dplyr::count(urine_color_r) %>%
  ungroup() %>% 
  dplyr::mutate(percent = n/sum(n))

# female
clean_data_wide %>% 
  filter(urine_color_split == "inadequate" & gender == "female") %>% 
  dplyr::group_by(urine_color_r) %>% 
  dplyr::count(urine_color_r) %>%
  ungroup() %>% 
  dplyr::mutate(percent = n/sum(n))

#void frequency
plot <- ggplot(clean_data_wide, aes(void_frequency, fill = void_frequency_split, na.rm = TRUE)) +
  geom_bar()
plot

clean_data_wide %>% 
  ungroup() %>% 
  dplyr::reframe(mean = mean(void_frequency, na.rm = TRUE),
            sd = sd(void_frequency, na.rm = TRUE), 
            range = range(void_frequency, na.rm = TRUE))

clean_data_wide %>% 
  group_by(urine_color_split) %>% 
  dplyr::reframe(mean = mean(void_frequency, na.rm = TRUE),
            sd = sd(void_frequency, na.rm = TRUE), 
            range = range(void_frequency, na.rm = TRUE))

# 51% was adequately hydrated: void frequency
clean_data_wide %>% 
  ungroup() %>% 
  select(void_frequency_split) %>% 
  dplyr::count(void_frequency_split == "adequate") %>%
  dplyr::mutate(percent = n/sum(n))

# correlation between two hydration measures: r = 19
cor.test(clean_data_wide$urine_color_r, clean_data_wide$void_frequency, na.rm = TRUE)

# same without colorblind pp
sub <- clean_data_wide %>% 
  ungroup() %>% 
  filter(color_blind == "no") %>% 
  select(urine_color_r, void_frequency) 

cor.test(sub$urine_color_r, sub$void_frequency, na.rm = TRUE)

# confidence
plot <- geom_plot(clean_data_wide, color_confidence_1
                  , "color_confidence_1")
plot

clean_data_wide %>% 
  ungroup() %>% 
  dplyr::summarize(mean = mean(color_confidence_1, na.rm = TRUE),
            sd = sd(color_confidence_1, na.rm = TRUE),
            median = median(color_confidence_1, na.rm = TRUE))

clean_data_wide %>% 
  group_by(urine_color_split) %>% 
  dplyr::reframe(mean = mean(void_frequency, na.rm = TRUE),
            sd = sd(void_frequency, na.rm = TRUE), 
            range = range(void_frequency, na.rm = TRUE))

# those who are more confident about color are also more about frequency --> compute average
cor.test(clean_data_wide$color_confidence_1, clean_data_wide$void_confidence_1, na.rm = TRUE)

data_hydration <- clean_data_wide %>% 
  select(pp, urine_color_r, void_frequency, color_confidence_1, void_confidence_1) %>% 
  mutate(confidence = (color_confidence_1+void_confidence_1)/2)

# Here we plot urine color and void frequency, showing in green those who have both adequate urine color and void frequency, and in red those who are inadequate in both. Seeing from the many points outside these areas, it seems that these measures are not very discriminatory. 

hydration_plot <- ggplot(data_hydration, (aes(x = urine_color_r, 
                            y = void_frequency, color = confidence))) +
  geom_jitter(size = 1, width = 0.3, height = 0.3) + 
  stat_smooth(method = "lm", color = "black", fullrange = TRUE, se = FALSE) +
  #geom_hline(yintercept = 5) + 
  geom_hline(yintercept = 7) + 
  geom_vline(xintercept = 6) + 
  annotate("rect", xmin = 6, xmax = 9, ymin = 7, ymax = 14, color = NA, fill = "green", alpha = 0.1) + 
  annotate("rect", xmin = 0, xmax = 6, ymin = 0, ymax = 7, color = NA, fill = "red", alpha = 0.1) + 
  scale_x_continuous(breaks = c(0, 2, 4, 6, 8))

ggsave(hydration_plot, file= "hydration_plot.png", width = 10, height = 8)

data_bubble <- clean_data_wide %>% 
  select(pp, urine_color_split, void_frequency_split, color_confidence_1, void_confidence_1) %>% 
  mutate(confidence = (color_confidence_1+void_confidence_1)/2) 

#library(Rmisc)
#library(plyr)
bubble_means <- summarySE(data_bubble, measurevar="confidence", groupvars=c("void_frequency_split", "urine_color_split"), na.rm = TRUE)
#detach("package:Rmisc")
#detach("package:plyr")

bubble_means <- bubble_means %>% 
  filter(void_frequency_split %ni% NA_real_) %>% 
  mutate(confidence = as.numeric(confidence))

# more than 30% of pp have inconsistent classifications, confidence ratings do not seem to be related

ggplot(subset(bubble_means), aes(x=urine_color_split, y=void_frequency_split, size = N, color = confidence, 
                                 label = paste0(sprintf("%0.1f", round(N/sum(N)*100, digits = 1)), "%"))) + geom_point(aes(size = N, color = confidence), alpha=0.7) +  scale_color_gradient(limits = c(0, 100)) + 
  geom_text(vjust = -1, color = "black",size = 4)

# combination of both hydration measures (Adams et al., 2021)
```

## Fig. 2D
```{r}
pal <- drygatebrewer::drygate_palette("TakeMeTotheRiver")

# reshape to long format for water + ssb
long_data <- clean_data_wide %>%
  select(urine_color_split, total_water, total_ssb) %>%
  pivot_longer(
    cols = c(total_water, total_ssb),
    names_to = "drink_type",
    values_to = "amount_l"
  ) %>%
  mutate(
    drink_type = dplyr::recode(
      drink_type,
      total_water = "Water",
      total_ssb = "Sugar-sweetened beverages"
    ),
    drink_type = factor(drink_type, levels = c("Water", "Sugar-sweetened beverages")),
    urine_color_split = factor(urine_color_split, levels = c("adequate", "inadequate"))
  )

summary_data <- long_data %>%
  #mutate(amount_ml = amount_l * 1000) %>%   # L -> mL
  dplyr::group_by(drink_type, urine_color_split) %>%
  dplyr::summarise(
    n        = n(),
    mean_ml  = mean(amount_l, na.rm = TRUE),
    sd_ml    = sd(amount_l, na.rm = TRUE),
    se_ml    = sd_ml / sqrt(n),
    ci_mult  = ifelse(n > 1, qt(0.975, df = n - 1), NA_real_),   # 95% t multiplier
    ci_low   = mean_ml - ci_mult * se_ml,
    ci_high  = mean_ml + ci_mult * se_ml,
    .groups  = "drop"
  ) %>% 
  mutate(
    drink_type = dplyr::recode(as.character(drink_type), "SSB" = "Sugar-sweetened beverages"),
    drink_type = factor(drink_type, levels = c("Water", "Sugar-sweetened beverages")),
    urine_color_split = factor(urine_color_split, levels = c("adequate", "inadequate"))
  )

# plot
figure_2D <- ggplot(long_data,
                           aes(x = urine_color_split, y = amount_l, fill = urine_color_split)) +
  geom_flat_violin(
    position = position_nudge(x = .15, y = 0),
    trim = FALSE, width = 0.8, alpha = 1, color = NA
  ) +
  geom_jitter(
    width = 0.12, height = 0, size = 0.7, alpha = 0.2,
    aes(color = urine_color_split)
    #, show.legend = FALSE
  ) +
  geom_errorbar(
    data = summary_data,
    aes(x = urine_color_split, ymin = ci_low, ymax = ci_high),
    inherit.aes = FALSE,
    width = 0.12, color = "black", linewidth = 0.5
  ) +
  geom_point(
    data = summary_data,
    aes(x = urine_color_split, y = mean_ml),
    inherit.aes = FALSE,
    shape = 23, size = 2, color = "black", fill = "black"
  ) +
  scale_fill_manual(
    values = c("adequate" = pal[3], "inadequate" = pal[1]),
    breaks = c("adequate", "inadequate"),
    labels = c("adequate", "inadequate")
  ) +
  scale_color_manual(
    values = c("adequate" = pal[3], "inadequate" = pal[1]),
    breaks = c("adequate", "inadequate"),
    guide = "none"
  ) +
  facet_wrap(~drink_type, ncol = 2, scales = "fixed") +
  #coord_flip() +
  labs(x = NULL, y = "Mean consumption (ml)", fill = "Hydration") +
  theme(
    panel.border   = element_rect(colour = "black", fill = NA, size = 1),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    axis.text.y    = element_text(size = 12, color = "black"),
    axis.title.y   = element_text(size = 12, color = "black", face = "bold"),
    axis.text.x    = element_blank(),
    axis.title.x   = element_blank(),
    axis.ticks.y   = element_blank(),
    axis.ticks.x   = element_blank(),
    legend.title   = element_blank(),
    legend.text    = element_text(size = 12),
    legend.position = "top", strip.background = element_blank(),
    #strip.text = element_text(size = 12, color = "black", face = "bold"),
    plot.title = element_text(size=12, colour = "black")) + #guides(fill = "none") + 
  ggtitle("Hydration status and water and sugar-sweetened beverages consumption")

figure_2D

#ggsave(figure_2D, file= "figure_2D.png", width = 12, height = 8)
```

## Stacked bar graph (intake per SES)

```{r}
# mean consumption per SES category
ggplot(clean_data_wide,
       aes(x = education_cat,
           y = total_fluid_extra, 
           fill = education_cat)) + 
  geom_bar(stat = "summary") + 
  theme(axis.text.x=element_blank())

# it seems that low SES drink more in total looking at average consumption (amount_ml) per drink type because there are way less observations for low SES, e.g., 0 sd for drink "other", SDs are much larger for other observations (e.g., alcohol)

clean_data$education_cat <- as.factor(clean_data$education_cat)

# with wide format
total_means_ses <- clean_data_wide %>%
  dplyr::group_by(education_cat) %>% 
  dplyr::summarize(across(c("total_water", "total_ssb", "total_other",
                            "total_milk", "total_hot", "total_diet",
                            "total_alcohol"), mean)) %>% 
  as.data.frame()

# transform to long format
total_means_ses <- gather(total_means_ses, drink_type_name, amount_ml, total_water:total_alcohol)

# to order drink types in terms of most often drunk
clean_data_wide %>% 
  ungroup() %>% 
  dplyr::summarize(mean_water = mean(total_water),
                   mean_ssb = mean(total_ssb),
                   mean_milk = mean(total_milk),
                   mean_hot = mean(total_hot),
                   mean_alcohol = mean(total_alcohol),
                   mean_diet = mean(total_diet),
                   mean_juice = mean(total_juice),
                   mean_other = mean(total_other)) 

total_means_ses <- total_means_ses %>% 
  mutate(drink_type_name = factor(drink_type_name, levels = 
                                    c("total_other", 
                                      "total_alcohol",
                                      "total_diet",
                                      "total_milk",
                                      "total_ssb", 
                                      "total_hot",
                                      "total_water")))

pal <- drygate_palette(10, name = "TakeMeTotheRiver", type = "continuous")
pal <- pal[-c(6, 8, 10)] #remove white and in-between color

palette_check(pal, plot = TRUE)

# mean per drink type for the combined plot
figure3B <- ggplot(total_means_ses,
                  aes(x = education_cat,
                      y = amount_ml,
                      fill = drink_type_name)) + 
  geom_bar(stat = "identity") +
  scale_x_discrete(limits = rev) +
  scale_fill_manual(values = pal, labels = c("total_water" = "water", "total_ssb" = "SSBs", 
                                             "total_other" = "other", "total_milk" = "milk drinks",
                                             "total_hot" = "hot drinks",
                                             "total_diet" = "diet beverages",
                                             "total_alcohol" = "alcohol")) +
  coord_flip() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, size = 1), #to create a border
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    axis.text.x=element_text(size=12, color="black"),
    axis.title.y=element_blank(),
    axis.text.y=element_blank(),
    axis.title.x=element_text(size=12, color='black', face = "bold"),
    axis.ticks.y=element_blank(),
    axis.ticks.x=element_blank(),
    legend.title=element_blank(),
    legend.text=element_text(size=12),
    legend.position = "top",
    legend.box = "horizontal",
    legend.direction = "horizontal") + ylab("Mean consumption (ml)") +
  guides(fill=guide_legend(nrow=1, byrow=TRUE, reverse = TRUE))
figure3B
```

```{r}
# with wide format
total_means_ses_gender <- clean_data_wide %>%
  dplyr::filter(gender %in% c("male", "female")) %>% 
  dplyr::group_by(education_cat, gender) %>% 
  dplyr::summarize(across(c("total_water", "total_ssb", "total_other",
                            "total_milk", "total_hot", "total_diet",
                            "total_alcohol"), mean)) %>% 
  as.data.frame()

# transform to long format
total_means_ses_gender <- gather(total_means_ses_gender, drink_type_name, amount_ml, total_water:total_alcohol)

figure5_extra <- ggplot(data = subset(total_means_ses_gender, gender %in% c("male", "female")),
       aes(x = education_cat,
           y = amount_ml,
           fill = drink_type_name)) + 
  geom_bar(stat = "identity") +
  scale_x_discrete(limits = rev) +
  scale_fill_viridis_d(labels = c("total_water" = "water", "total_ssb" = "SSBs", "total_other" = "other", "total_milk" = "milk drinks",
                                  "total_hot" = "hot drinks", 
                                  "total_diet" = "diet beverages",
                                 "total_alcohol" = "alcohol")) + 
  coord_flip() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, size = 1), #to create a border
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    axis.text.y=element_text(size=12, color="black"),
    axis.title.y=element_blank(),
    axis.text.x=element_text(size=12, color='black'),
    axis.title.x=element_text(size=12, color='black', face = "bold"),
    axis.ticks.y=element_blank(),
    axis.ticks.x=element_blank(),
    legend.title=element_blank(),
    legend.text=element_text(size=12),
    legend.position = "top",
    legend.box = "horizontal",
    legend.direction = "horizontal") + ylab("Mean consumption (ml)") +
#+ labs(fill = "Drink Type") 
  guides(fill=guide_legend(nrow=1,byrow=TRUE, reverse = TRUE)) +
  facet_grid(gender ~., scales = "free", space = "free", drop = TRUE)
figure5_extra

ggsave(figure5_extra, file= "figure5_extra.png", width = 12, height = 8)
```
## Fig. 2C - Consumption per urine color
```{r}
clean_data_wide %>% 
  dplyr::group_by(urine_color_split) %>% 
  dplyr::summarize(
    total_fluid = mean(total_fluid_extra, na.rm = TRUE),
    sd_fluid = sd(total_fluid_extra, na.rm = TRUE),
    mean_ssb = mean(total_ssb, na.rm = TRUE),
    sd_ssb = sd(total_ssb, na.rm = TRUE),
    mean_water = mean(total_water, na.rm = TRUE),
    sd_water = sd(total_water, na.rm = TRUE)
  )

# with wide format
total_means <- clean_data_wide %>%
  dplyr::group_by(urine_color_split) %>% 
  dplyr::summarize(across(c("total_water", "total_ssb", "total_other",
                            "total_milk", "total_hot", "total_diet",
                            "total_alcohol"), mean)) %>% 
  as.data.frame()

# transform to long format
means_urine <- gather(total_means, drink_type_name, amount_ml, total_water:total_alcohol)

pal <- drygate_palette(10, name = "TakeMeTotheRiver", type = "continuous")
pal <- pal[-c(6, 8, 10)] #remove white and in-between color

means_urine <- means_urine %>% 
  mutate(urine_color_split = factor(urine_color_split, levels = c("inadequate",
                                                                  "adequate"))) %>%
  mutate(drink_type_name = factor(drink_type_name, levels = 
                                    c("total_other", 
                                      "total_alcohol",
                                      "total_diet",
                                      "total_milk",
                                      "total_ssb", 
                                      "total_hot",
                                      "total_water")))

figure_C <- ggplot(means_urine,
                   aes(x = urine_color_split,
                       y = amount_ml,
                       fill = drink_type_name)) +
  geom_col(position = "stack", width = 0.8, alpha = 1) +
  scale_fill_manual(
    values = pal,
    labels = c("total_water" = "water",
               "total_ssb"   = "SSBs",
               "total_other" = "other",
               "total_milk"  = "milk drinks",
               "total_hot"   = "hot drinks",
               "total_diet"  = "diet beverages",
               "total_alcohol" = "alcohol")
  ) +
  scale_x_discrete(labels = c("inadequate" = "Inadequate", "adequate" = "Adequate")) +
  ylab("Mean consumption (ml)") +
  #labs(fill = "Drink Type") +
  coord_flip() +   # rotate 90 degrees
  guides(fill = guide_legend(nrow = 1, byrow = TRUE, reverse = TRUE)) +
  theme_minimal(base_size = 12) +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    panel.border = element_rect(colour = "black", fill = NA, size = 1),
    axis.title.y = element_blank(),
    axis.text.x = element_text(size = 12),
    axis.title.x = element_text(size = 12, face = "bold"),
    legend.title = element_blank(),
    legend.text = element_text(size = 9),
    legend.position = "none",
    plot.title = element_text(size=12, colour = "black")) + 
  #guides(fill = "none") + 
  ggtitle("Hydration and consumption")
figure_C
```

## Consumption per void frequency

```{r}
# with wide format
total_means <- clean_data_wide %>%
  dplyr::filter(!is.na(void_frequency_split)) %>% 
  dplyr::group_by(void_frequency_split) %>% 
  dplyr::summarize(across(c("total_water", "total_ssb", "total_other",
                            "total_milk", "total_hot", "total_diet",
                            "total_alcohol"), mean)) %>% 
  as.data.frame()

# transform to long format
means_void <- gather(total_means, drink_type_name, amount_ml, total_water:total_alcohol)

pal <- drygate_palette(10, name = "TakeMeTotheRiver", type = "continuous")
pal <- pal[-c(6, 8, 10)] #remove white and in-between color

# mean per drink type compared to total mean
ggplot(means_void,
                  aes(x = void_frequency_split,
                      y = amount_ml,
                      fill = drink_type_name)) + 
  geom_bar(stat = "identity") +
  scale_fill_manual(values = pal, labels = c("total_water" = "water", "total_ssb" = "SSBs", "total_other" = "other", "total_milk" = "milk drinks",
                                             "total_hot" = "hot drinks", 
                                             "total_diet" = "diet beverages",
                                             "total_alcohol" = "alcohol")) + 
   scale_x_discrete(labels = c("inadequate" = "Inadequate", "adequate" = "Adequate")) +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, size = 1), #to create a border
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    axis.text.y=element_text(size=12, color="black"),
    axis.title.x=element_blank(),
    axis.text.x=element_text(size=12, color='black', face = "bold"),
    axis.title.y=element_text(size=12, color='black', face = "bold"),
    axis.ticks.y=element_blank(),
    axis.ticks.x=element_blank(),
    legend.title=element_text(size=12, color='black', face = "bold"),
    legend.text=element_text(size=12)) + ylab("Mean consumption (ml)") + labs(fill = "Drink Type")
#labs(title = "Beverage intake per gender and drink type (mean ml)", #subtitle = "Average consumption (ml)") 
```

## Fig.2 combined
```{r}
right_stack <- (figure_B / figure_C)

# top row: figure_A (left) + right_stack (right)
top_row <- figure_A + right_stack + 
  plot_layout(ncol = 2, widths = c(1, 1.5))

# final combined: top row above figure_D (figure_D spans both columns)
combined <- top_row / figure_2D +
  plot_layout(heights = c(1, 1)) +   # tweak heights as desired
  plot_annotation(tag_levels = "A") + theme(legend.position = "top")

combined
ggsave("figure_ABC_combined.png", combined, width = 12, height = 10, dpi = 300, device = ragg::agg_png)
```

## Fig.2 combined (alternative)
```{r, include = FALSE, eval = FALSE}
right_stack <- (figure_B / figure_C) +
  plot_layout(guides = "collect") +
  theme(legend.position = "top")

# top row: figure_A (left) + right_stack (right)
top_row <- figure_A_alt + right_stack +
  plot_layout(ncol = 2, widths = c(1, 1.5))

# final combined: top row above figure_D (figure_D spans both columns)
combined <- top_row / figure_2D +
  plot_layout(heights = c(1, 1)) +   # tweak heights as desired
  plot_annotation(tag_levels = "A") + theme(legend.position = "top")

combined
ggsave("figure_ABC_combined_alt.png", combined, width = 12, height = 10, dpi = 300, device = ragg::agg_png)
```

# Hypothesis 1: Water intake will be positively associated with hydration status (lighter urine colour)

! Problem: regression assumptions are funky. One problem: water and ssb intake are not at all linear (a lot of zeroes), using logistic removes the assumption of linear predictors + makes more sense anyway given the categorical (ordinal) nature of urine colour. 

## Linear
```{r}
# center values
clean_data_wide$total_fluid_extra_cent <- scale(clean_data_wide$total_fluid_extra,center = TRUE, scale = TRUE)

clean_data_wide$total_water_cent <- scale(clean_data_wide$total_water,center = TRUE, scale = TRUE)

clean_data_wide$total_ssb_cent <- scale(clean_data_wide$total_ssb,center = TRUE, scale = TRUE)

clean_data_wide$age_cent <- scale(clean_data_wide$age, center = TRUE, scale = TRUE)

clean_data_wide$BMI_cent <- scale(clean_data_wide$BMI, center = TRUE, scale = TRUE)

clean_data_wide$MET_PA_cent <- scale(clean_data_wide$MET_PA, center = TRUE, scale = TRUE)

clean_data_wide$FV_portions_cent <- scale(clean_data_wide$FV_portions, center = TRUE, scale = TRUE)

clean_data_wide$total_sugar_cent <- scale(clean_data_wide$total_sugar, center = TRUE, scale = TRUE)

clean_data_wide$color_confidence_1_cent <- scale(clean_data_wide$color_confidence_1, center = TRUE, scale = TRUE)

clean_data_wide <- clean_data_wide %>% 
  mutate(day = as.numeric(day))

clean_data_wide$color_confidence_1_cent <- scale(clean_data_wide$color_confidence_1, center = TRUE, scale = TRUE)

# intake of other fluids
clean_data_wide <- clean_data_wide %>%
  dplyr::group_by(pp) %>%
  dplyr::mutate(
    other_fluids_except_water_cent = total_fluid_extra_cent - total_water_cent) %>%
  dplyr::mutate(
    other_fluids_except_ssb_cent = total_fluid_extra_cent - total_ssb_cent) %>%
  dplyr::mutate(
    other_fluids_except_ssb = total_fluid_extra - total_ssb)

# step 1
hyp1_1 <- lm(urine_color_r ~ total_water_cent, data = clean_data_wide)
summary(hyp1_1)
confint(hyp1_1)

par(mfrow = c(2, 2))
plot(hyp1_1)

# scale-location (model 3 looks funky, try log-transformation)
hyp1_1 <- lm(log(urine_color_r) ~ total_water_cent, data = clean_data_wide)
# log nor sqrt helps
par(mfrow=c(1,1))
plot(hyp1_1, 3)

# looking at outliers (plot 4) shows a couple of more outliers (standardized residuals > 3), but using Cook's distance does not signal any problems
plot(hyp1_1, 4)
plot(hyp1_1, 5)

# in case of leverage, points should be lower than the leverage statistics of 2(p + 1)/n (http://www.sthda.com/english/articles/39-regression-model-diagnostics/161-linear-regression-assumptions-and-diagnostics-in-r-essentials/)
4/1118 #=0.00357
```

## Logistic 

H1 with hydration status (urine colour) as categorical (median split)

```{r}
# step 1
hyp1_1 <- glm(urine_color_split ~ total_water_cent, data = clean_data_wide, family = "binomial")
summary(hyp1_1)

# diagnostics look <3
dat.sim <- simulateResiduals(hyp1_1, 1000)
plot(dat.sim) #residuals look good (linearity test with transformed log to "normal" residuals)
testDispersion(hyp1_1) 
testUniformity(dat.sim)
testOutliers(dat.sim, plot = T) #no influential observations

hyp1_1_tb <- tbl_regression(hyp1_1, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            label = 
                              c(total_water_cent ~ "Total water intake")) %>% 
                              bold_p(t = 0.05)

# Nagelkerke R2
performance::r2_nagelkerke(hyp1_1)
# sample size
broom::glance(hyp1_1)$nobs

# step 2: control vars separately 0/1 for each control factor
hyp1_2_hyp <- glm(urine_color_split ~ total_water_cent + color_blind + medication + hypertensive + menstruation + pregnant_lactating + high_protein_caloric + day + location, data = clean_data_wide, family = "binomial")
summary(hyp1_2_hyp)

# only 3 pp with hypertension, SE inflated, remove var from regression
hyp1_2 <- glm(urine_color_split ~ total_water_cent + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location, data = clean_data_wide, family = "binomial")
summary(hyp1_2)

hyp1_2_tb <- tbl_regression(hyp1_2, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(total_water_cent ~ "Total water intake",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet")) %>% 
                               bold_p(t = 0.05)

# Nagelkerke R2
performance::r2_nagelkerke(hyp1_2)
# sample size
broom::glance(hyp1_2)$nobs

# step 3
hyp1_3 <- glm(urine_color_split ~ total_water_cent + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location + age_cent + gender + BMI_cent + MET_PA_cent, data = clean_data_wide, family = "binomial")
summary(hyp1_3)

hyp1_3_tb <- tbl_regression(hyp1_3, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(total_water_cent ~ "Total water intake",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet",
                               age_cent ~ "Age", 
                               gender ~ "Gender", 
                               BMI_cent ~ "BMI (kg/m2)", 
                               MET_PA_cent ~ "Physical activity (MET/day)"))  %>% 
                               bold_p(t = 0.05)

# Nagelkerke R2
performance::r2_nagelkerke(hyp1_3)
# sample size
broom::glance(hyp1_3)$nobs

model_aics <- c(
  "Model 1" = AIC(hyp1_1),
  "Model 2" = AIC(hyp1_2),
  "Model 3" = AIC(hyp1_3)
)
model_aics

tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(hyp1_1_tb, hyp1_2_tb, hyp1_3_tb),
    tab_spanner = c("**Step 1**", "**Step 2**", "**Step 3**")
  )
```
```{r}
tbl_merge_ex2
```
```{r}
# Convert to gt object
gt_tbl <- as_gt(tbl_merge_ex2)

# Write to Word
gtsave(gt_tbl, "tbl_merge_ex2.docx")
```

### OR per glass of water
```{r}
hyp1_1 <- glm(urine_color_split ~ total_water, data = clean_data_wide, family = "binomial")
summary(hyp1_1)

b_per_ml <- coef(hyp1_1)["total_water"]

b_per_250 <- b_per_ml * 250
OR_250 <- exp(b_per_250)

(OR_250-1) *100

se <- summary(hyp1_1)$coef["total_water", "Std. Error"]

ci_low  <- exp(b_per_250 - 1.96 * se * 250)
ci_high <- exp(b_per_250 + 1.96 * se * 250)

c(OR_250 = OR_250, CI_low = ci_low, CI_high = ci_high)

# per 500 ml
b_per_500 <- b_per_ml * 500
OR_500 <- exp(b_per_500)

(OR_500-1) *100
```

## Exploring: Does this hold when controlling for additional variables
```{r}
# including other vars
hyp1_4 <- glm(urine_color_split ~ total_water_cent + other_fluids_except_water_cent + FV_portions_cent + total_sugar_cent + color_confidence_1_cent, data = clean_data_wide, family = "binomial")
summary(hyp1_4)
confint(hyp1_4)

# OR
exp(coef(hyp1_4))
exp(confint(hyp1_4))

# collinearity
check_collinearity(hyp1_4)

# the more sugar people consume, the less water they drink and the less hydrated they are
cor.test(clean_data_wide$total_sugar, clean_data_wide$total_water_cent)

cor.test(clean_data_wide$total_sugar, clean_data_wide$urine_color_r)
```

# Hypothesis 2: SSB intake will be negatively associated with hydration status (lighter urine colour). 

```{r}
# step 1
hyp2_1 <- glm(urine_color_split ~ total_ssb_cent, data = clean_data_wide, family = "binomial")
summary(hyp2_1)

# diagnostics look great
dat.sim <- simulateResiduals(hyp2_1, 1000)
plot(dat.sim) #residuals look good (linearity test with transformed log to "normal" residuals)
testDispersion(hyp2_1) 
testUniformity(dat.sim)
testOutliers(dat.sim, plot = T) #no influential observations

hyp2_1_tb <- tbl_regression(hyp2_1, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            label = 
                              c(total_ssb_cent ~ "Total SSB intake"))  %>% 
                              bold_p(t = 0.05)
  
# Nagelkerke R2
performance::r2_nagelkerke(hyp2_1)
# sample size
broom::glance(hyp2_1)$nobs

# step 2: control vars separately 0/1 for each control factor
hyp2_2 <- glm(urine_color_split ~ total_ssb_cent + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location, data = clean_data_wide, family = "binomial")
summary(hyp2_2)

hyp2_2_tb <- tbl_regression(hyp2_2, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(total_ssb_cent ~ "Total SSB intake",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet")) %>% 
  bold_p(t = 0.05)

# Nagelkerke R2
performance::r2_nagelkerke(hyp2_2)
# sample size
broom::glance(hyp2_2)$nobs

# step 3
hyp2_3 <- glm(urine_color_split ~ total_ssb_cent + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location + age_cent + gender + BMI_cent + MET_PA_cent, data = clean_data_wide, family = "binomial")
summary(hyp2_3)

#multicolinearity: as a rule of thumb, a VIF value that exceeds 5 or 10 indicates a problematic amount of collinearity (https://quantifyinghealth.com/vif-threshold/)
check_collinearity(hyp2_3)

hyp2_3_tb <- tbl_regression(hyp2_3, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(total_ssb_cent ~ "Total SSB intake",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet",
                               age_cent ~ "Age", 
                               gender ~ "Gender", 
                               BMI_cent ~ "BMI (kg/m2)", 
                               MET_PA_cent ~ "Physical activity (MET/day)"))  %>% 
                              bold_p(t = 0.05)

# Nagelkerke R2
performance::r2_nagelkerke(hyp2_3)
# sample size
broom::glance(hyp2_3)$nobs

tbl_merge_ex3 <-
  tbl_merge(
    tbls = list(hyp2_1_tb, hyp2_2_tb, hyp2_3_tb),
    tab_spanner = c("**Step 1**", "**Step 2**", "**Step 3**")
  )
```
```{r}
tbl_merge_ex3
```
```{r}
# Convert to gt object
gt_tbl <- as_gt(tbl_merge_ex3)

# Write to Word
gtsave(gt_tbl, "tbl_merge_ex3.docx")
```

## Exploring: Does this hold when controlling for additional variables
```{r}
# including other vars
hyp2_4 <- glm(urine_color_split ~ total_ssb_cent + other_fluids_except_ssb_cent + FV_portions_cent + total_sugar_cent + color_confidence_1_cent, data = clean_data_wide, family = "binomial")
summary(hyp2_4)
confint(hyp2_4)
# OR
exp(coef(hyp2_4))
exp(confint(hyp2_4))

# collinearity
check_collinearity(hyp2_4)

### OR per glass of SSB
hyp2_4 <- glm(urine_color_split ~ total_ssb + other_fluids_except_ssb_cent + FV_portions_cent + total_sugar_cent + color_confidence_1_cent, data = clean_data_wide, family = "binomial")

b_per_ml <- coef(hyp2_4)["total_ssb"]

b_per_250 <- b_per_ml * 250
OR_250 <- exp(b_per_250)
(OR_250-1)*100

b_per_500 <- b_per_ml * 500
OR_500 <- exp(b_per_500)
(OR_500-1)*100

# test interaction between SSB and fluid intake
hyp2_interaction <- glm(urine_color_split ~ total_ssb_cent * other_fluids_except_ssb_cent + FV_portions_cent + total_sugar_cent + color_confidence_1_cent, data = clean_data_wide, family = "binomial")
summary(hyp2_interaction)
# OR
exp(coef(hyp2_interaction))
exp(confint(hyp2_4))

# does water intake and ssb intake correlate?
cor.test(clean_data_wide$total_ssb_cent, clean_data_wide$total_water_cent)
```

# Hypothesis 3: Higher SES is associated with better hydration status. 
```{r}
clean_data_wide <- clean_data_wide %>% 
  mutate(education_cat = factor(education_cat, levels = c("No formal qualifications", "Secondary education", "High school diploma/A-levels", "Technical/community college", "Undergraduate degree", "Graduate/Doctorate degree"))) %>% 
  mutate(education_split = case_when(education_cat %in% c("No formal qualifications", "Secondary education", "High school diploma/A-levels")  ~ "low",
                                     education_cat %in% c("Technical/community college", "Undergraduate degree", "Graduate/Doctorate degree") ~ "high")) %>% 
  mutate(education_split = factor(education_split, levels = c("low", "high")))

clean_data_wide %>% 
  group_by(education_split) %>% 
  dplyr::count(education_split) %>%
  ungroup() %>% 
  mutate(percent = n/sum(n)) 
```

```{r}
# step 1
hyp3_1 <- glm(urine_color_split ~ education_split, data = clean_data_wide, family = "binomial")
summary(hyp3_1)

# diagnostics look <3
dat.sim <- simulateResiduals(hyp3_1, 1000)
plot(dat.sim) #residuals look good (linearity test with transformed log to "normal" residuals)
testDispersion(hyp3_1) 
testUniformity(dat.sim)
testOutliers(dat.sim, plot = T) #no influential observations

hyp3_1_tb <- tbl_regression(hyp3_1, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            label = 
                              c(education_split ~ "Education"))  %>% 
                              bold_p(t = 0.05)

# Nagelkerke R2
performance::r2_nagelkerke(hyp3_1)
# sample size
broom::glance(hyp3_1)$nobs

# step 2
hyp3_2 <- glm(urine_color_split ~ education_split + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location, data = clean_data_wide, family = "binomial")
summary(hyp3_2)

hyp3_2_tb <- tbl_regression(hyp3_2, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(education_split ~ "Education",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet"))  %>% 
                              bold_p(t = 0.05)

# Nagelkerke R2
performance::r2_nagelkerke(hyp3_2)
# sample size
broom::glance(hyp3_2)$nobs

# step 3
hyp3_3 <- glm(urine_color_split ~ education_split + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location + age_cent + gender + BMI_cent + MET_PA_cent, data = clean_data_wide, family = "binomial")
summary(hyp3_3)

hyp3_3_tb <- tbl_regression(hyp3_3, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(education_split ~ "Education",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet",
                               age_cent ~ "Age", 
                               gender ~ "Gender", 
                               BMI_cent ~ "BMI (kg/m2)", 
                               MET_PA_cent ~ "Physical activity (MET/day)"))  %>% 
                              bold_p(t = 0.05)

# Nagelkerke R2
performance::r2_nagelkerke(hyp3_3)
# sample size
broom::glance(hyp3_3)$nobs

tbl_merge_ex4 <-
  tbl_merge(
    tbls = list(hyp3_1_tb, hyp3_2_tb, hyp3_3_tb),
    tab_spanner = c("**Step 1**", "**Step 2**", "**Step 3**")
  )
```
```{r}
tbl_merge_ex4
```
```{r}
# Convert to gt object
gt_tbl <- as_gt(tbl_merge_ex4)

# Write to Word
gtsave(gt_tbl, "tbl_merge_ex4.docx")
```

```{r}
# since more low-SES might have been collected on later survey days, we test H3 including only participants who participated on day 1 (NS) 
hyp3_1_day <- glm(urine_color_split ~ education_split, data = subset(clean_data_wide, day %in% c(7)), family = "binomial")
summary(hyp3_1_day)
```

## Does this hold when controlling for additional variables

```{r}
# other control variables
hyp3_1 <- glm(urine_color_split ~ education_split + total_fluid_extra_cent + FV_portions_cent + total_sugar_cent + color_confidence_1_cent, data = clean_data_wide, family = "binomial")
summary(hyp3_1)
confint(hyp3_1)

# OR
exp(coef(hyp3_1))
exp(confint(hyp3_1))

check_collinearity(hyp3_1)
```

## Fig. 3
```{r}
# per adequate vs. inadequate
pct_ses <- clean_data_wide %>%
  filter(!is.na(education_split) & !is.na(urine_color_split)) %>%
  group_by(education_split) %>%
  summarise(
    n = n(),
    n_adequate = sum(urine_color_split == "adequate", na.rm = TRUE)
  ) %>%
 ungroup() %>%
  mutate(
    pct_adequate = n_adequate / n
  )

prop_long <- clean_data_wide %>%
  filter(!is.na(education_split) & !is.na(urine_color_split)) %>%
  group_by(education_split, urine_color_split) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(education_split) %>%
  mutate(p = n / sum(n)) %>%
  ungroup() %>% 
  mutate(urine_color_split = factor(urine_color_split,
                                    levels = c("inadequate", "adequate"))) 

# select colors
pal <- drygatebrewer::drygate_palette("TakeMeTotheRiver")

figure3A_split <- ggplot(prop_long, aes(x = education_split, y = p, fill = urine_color_split)) +
  geom_col(position = "stack", alpha = 1) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_fill_manual(
    values = c("inadequate" = pal[1], "adequate" = pal[3]),
    breaks = c("adequate", "inadequate"),
    labels = c("adequate" = "Adequate", "inadequate" = "Inadequate")) +
  guides(fill = guide_legend(reverse = FALSE)) +
  scale_x_discrete(limits = c("high", "low"),
                   labels = c("low" = "Low", "high" = "High")) +
 # scale_x_discrete(limits = rev, labels = c("High", "Low")) +
  coord_flip() +
  labs(x = NULL, y = "Proportion", fill = "Hydration") +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, size = 1),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    axis.text.y = element_text(size = 12, color = "black"),
    axis.title.y = element_blank(),
    axis.text.x = element_text(size = 12, color = "black"),
    axis.title.x = element_text(size = 12, color = "black", face = "bold"),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "top",
    legend.box = "horizontal",
    legend.direction = "horizontal",
    plot.title = element_text(size=12, colour = "black", hjust = 0))
#+ ggtitle("Education and hydration status")

figure3A_split

pal <- drygate_palette(10, name = "TakeMeTotheRiver", type = "continuous")
pal <- pal[-c(6, 8, 10)] #remove white and in-between color

clean_data_wide %>% 
  ungroup() %>% 
  dplyr::summarize(mean_water = mean(total_water),
                   mean_ssb = mean(total_ssb),
                   mean_milk = mean(total_milk),
                   mean_hot = mean(total_hot),
                   mean_alcohol = mean(total_alcohol),
                   mean_diet = mean(total_diet),
                   mean_juice = mean(total_juice),
                   mean_other = mean(total_other)) 

# with wide format
total_means_ses_split <- clean_data_wide %>%
  dplyr::group_by(education_split) %>% 
  dplyr::summarize(across(c("total_water", "total_ssb", "total_other",
                            "total_milk", "total_hot", "total_diet",
                            "total_alcohol"), mean)) 

# transform to long format
total_means_ses_split <- gather(total_means_ses_split, drink_type_name, amount_ml, total_water:total_alcohol)

total_means_ses_split <- total_means_ses_split %>%
  mutate(drink_type_name = factor(drink_type_name, levels = 
                                    c("total_other", 
                                      "total_alcohol",
                                      "total_diet",
                                      "total_milk",
                                      "total_ssb", 
                                      "total_hot",
                                      "total_water")))

# mean per drink type
figure3B_split <- ggplot(total_means_ses_split,
                  aes(x = education_split,
                      y = amount_ml,
                      fill = drink_type_name)) + 
  geom_bar(stat = "identity", alpha = 1) +
  scale_x_discrete(limits = c("high", "low"),
                   labels = c("low" = "Low", "high" = "High")) +
  scale_fill_manual(values = pal, labels = c("total_water" = "water", "total_ssb" = "SSBs", 
                                             "total_other" = "other", "total_milk" = "milk drinks",
                                             "total_hot" = "hot drinks",
                                             "total_diet" = "diet beverages",
                                             "total_alcohol" = "alcohol")) +
  coord_flip() +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, size = 1), #to create a border
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    axis.text.x=element_text(size=12, color="black"),
    axis.title.y=element_blank(),
    axis.text.y=element_blank(),
    axis.title.x=element_text(size=12, color='black', face = "bold"),
    axis.ticks.y=element_blank(),
    axis.ticks.x=element_blank(),
    legend.title=element_blank(),
    legend.text=element_text(size=12),
    legend.position = "top",
    legend.box = "horizontal",
    legend.direction = "horizontal",
    plot.title = element_text(size=12, colour = "black")) + 
  ylab("Mean consumption (ml)") + 
  guides(fill=guide_legend(nrow=1, byrow=TRUE, reverse = TRUE)) 
#+ ggtitle("Education and consumption")
figure3B_split

# PER EDUCATION LEVEL
pct_ses <- clean_data_wide %>%
  filter(!is.na(education_cat) & !is.na(urine_color_split)) %>%
  group_by(education_cat) %>%
  summarise(
    n = n(),
    n_adequate = sum(urine_color_split == "adequate", na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate(
    pct_adequate = n_adequate / n
  )

pct_ses <- pct_ses %>%
  mutate(education_cat = factor(education_cat, levels = unique(education_cat)))  # adapt order if needed

prop_long <- clean_data_wide %>%
  filter(!is.na(education_cat) & !is.na(urine_color_split)) %>%
  group_by(education_cat, urine_color_split) %>%
  summarise(n = n(), .groups = "drop") %>%
  group_by(education_cat) %>%
  mutate(p = n / sum(n)) %>%
  ungroup() %>% 
  mutate(urine_color_split = factor(urine_color_split,
                                    levels = c("inadequate", "adequate"))) 

# select colors
pal <- drygatebrewer::drygate_palette("TakeMeTotheRiver")

figure3A <- ggplot(prop_long, aes(x = education_cat, y = p, fill = urine_color_split)) +
  geom_col(position = "stack", alpha = 1) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  scale_fill_manual(
    values = c("inadequate" = pal[1], "adequate" = pal[3]),
    breaks = c("adequate", "inadequate"),
    labels = c("inadequate" = "Inadequate", "adequate" = "Adequate")) +
  guides(fill = guide_legend(reverse = FALSE)) +
  scale_x_discrete(limits = rev) +
  coord_flip() +
  labs(x = NULL, y = "Proportion", fill = "Hydration") +
  theme(
    panel.border = element_rect(colour = "black", fill = NA, size = 1),
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    axis.text.y = element_text(size = 12, color = "black"),
    axis.title.y = element_blank(),
    axis.text.x = element_text(size = 12, color = "black"),
    axis.title.x = element_text(size = 12, color = "black", face = "bold"),
    axis.ticks.y = element_blank(),
    axis.ticks.x = element_blank(),
    legend.title = element_blank(),
    legend.text = element_text(size = 12),
    legend.position = "top",
    legend.box = "horizontal",
    legend.direction = "horizontal",
    plot.title = element_text(size=12, colour = "black", hjust = 0))
#+ ggtitle("Education and hydration status")

figure3A

combined_ses <- figure3A + figure3B + plot_layout(ncol = 2, widths = c(0.8, 1.2)) + plot_annotation(tag_levels = "A")
#combined_ses

ggsave("figure_3_combined.png", combined_ses, width = 16, height = 9, dpi = 300, device = ragg::agg_png)
```

# Exploratory analyses

## H3 with education as categorical

```{r, include = FALSE}
# step 1
hyp3_1 <- glm(urine_color_split ~ education_cat, data = clean_data_wide, family = "binomial")
summary(hyp3_1)

hyp3_1_tb <- tbl_regression(hyp3_1, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            label = 
                              c(education_cat ~ "Education"))  %>% 
                              bold_p(t = 0.05)

# step 2
hyp3_2 <- glm(urine_color_split ~ education_cat + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location, data = clean_data_wide, family = "binomial")
summary(hyp3_2)

hyp3_2_tb <- tbl_regression(hyp3_2, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(education_cat ~ "Education",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet"))  %>% 
                              bold_p(t = 0.05)

# step 3
hyp3_3 <- glm(urine_color_split ~ education_cat + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location +age_cent + gender + BMI_cent + MET_PA_cent, data = clean_data_wide, family = "binomial")
summary(hyp3_3)

hyp3_3_tb <- tbl_regression(hyp3_3, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(education_cat ~ "Education",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet",
                               age_cent ~ "Age", 
                               gender ~ "Gender", 
                               BMI_cent ~ "BMI (kg/m2)", 
                               MET_PA_cent ~ "Physical activity (MET/day)"))  %>% 
                              bold_p(t = 0.05)

tbl_merge_ex5 <-
  tbl_merge(
    tbls = list(hyp3_1_tb, hyp3_2_tb, hyp3_3_tb),
    tab_spanner = c("**Step 1**", "**Step 2**", "**Step 3**")
  )
```
```{r}
tbl_merge_ex5
```
```{r}
# Convert to gt object
gt_tbl <- as_gt(tbl_merge_ex5)

# Write to Word
gtsave(gt_tbl, "tbl_merge_ex5.docx")

# descriptives
clean_data_wide %>% 
  group_by(education_cat) %>% 
  select(urine_color_split) %>% 
  dplyr::count(urine_color_split == "adequate") %>%
  dplyr::mutate(percent = n/sum(n))
```

```{r, include = FALSE, eval = FALSE}
# step 1
hyp3_1 <- glm(urine_color_split ~ education_split*gender, data = clean_data_wide, family = "binomial")
summary(hyp3_1)

hyp3_1_tb <- tbl_regression(hyp3_1, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            label = 
                              c(education_cat ~ "Education"))  %>% 
                              bold_p(t = 0.05)

# step 2
hyp3_2 <- glm(urine_color_split ~ education_cat + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location, data = clean_data_wide, family = "binomial")
summary(hyp3_2)

hyp3_2_tb <- tbl_regression(hyp3_2, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(education_cat ~ "Education",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet"))  %>% 
                              bold_p(t = 0.05)

# step 3
hyp3_3 <- glm(urine_color_split ~ education_cat + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location + age_cent + gender + BMI_cent + MET_PA_cent, data = clean_data_wide, family = "binomial")
summary(hyp3_3)

hyp3_3_tb <- tbl_regression(hyp3_3, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(education_cat ~ "Education",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet",
                               age_cent ~ "Age", 
                               gender ~ "Gender", 
                               BMI_cent ~ "BMI (kg/m2)", 
                               MET_PA_cent ~ "Physical activity (MET/day)"))  %>% 
                              bold_p(t = 0.05)

tbl_merge_ex5 <-
  tbl_merge(
    tbls = list(hyp3_1_tb, hyp3_2_tb, hyp3_3_tb),
    tab_spanner = c("**Step 1**", "**Step 2**", "**Step 3**")
  )
```
```{r}
tbl_merge_ex5
```
```{r}
# Convert to gt object
gt_tbl <- as_gt(tbl_merge_ex5)

# Write to Word
gtsave(gt_tbl, "tbl_merge_ex5.docx")

# descriptives
clean_data_wide %>% 
  group_by(education_cat) %>% 
  select(urine_color_split) %>% 
  dplyr::count(urine_color_split == "adequate") %>%
  dplyr::mutate(percent = n/sum(n))
```

### Without "no formal education"

```{r}
clean_data_wide_edu <- clean_data_wide %>% 
  dplyr::filter(education_cat != "No formal qualifications") %>% 
  droplevels()

# step 1
hyp3_1 <- glm(urine_color_split ~ education_cat, data = clean_data_wide_edu, family = "binomial")
summary(hyp3_1)

hyp3_1_tb <- tbl_regression(hyp3_1, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            label = 
                              c(education_cat ~ "Education"))  %>% 
                              bold_p(t = 0.05)

# step 2
hyp3_2 <- glm(urine_color_split ~ education_cat + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location, data = clean_data_wide_edu, family = "binomial")
summary(hyp3_2)

hyp3_2_tb <- tbl_regression(hyp3_2, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(education_cat ~ "Education",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet"))  %>% 
                              bold_p(t = 0.05)

# step 3
hyp3_3 <- glm(urine_color_split ~ education_cat + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location + age_cent + gender + BMI_cent + MET_PA_cent, data = clean_data_wide_edu, family = "binomial")
summary(hyp3_3)

hyp3_3_tb <- tbl_regression(hyp3_3, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(education_cat ~ "Education",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet",
                               age_cent ~ "Age", 
                               gender ~ "Gender", 
                               BMI_cent ~ "BMI (kg/m2)", 
                               MET_PA_cent ~ "Physical activity (MET/day)"))  %>% 
                              bold_p(t = 0.05)

tbl_merge_ex5 <-
  tbl_merge(
    tbls = list(hyp3_1_tb, hyp3_2_tb, hyp3_3_tb),
    tab_spanner = c("**Step 1**", "**Step 2**", "**Step 3**")
  )
```
```{r}
tbl_merge_ex5
```

```{r}
# descriptives
clean_data_wide %>% 
  group_by(education_cat) %>% 
  select(urine_color_split) %>% 
  dplyr::count(urine_color_split == "adequate") %>%
  dplyr::mutate(percent = n/sum(n))
```

## H3 with income

```{r, include = FALSE}
# step 1
hyp3_1 <- glm(urine_color_split ~ income_split + household_size, data = clean_data_wide, family = "binomial")
summary(hyp3_1)
confint(hyp3_1, level=0.95)

hyp3_1_tb <- tbl_regression(hyp3_1, 
                              exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            label = 
                              c(income_split ~ "Income",
                                household_size ~ "Household size"))  %>% 
  bold_p(t = 0.05)

# step 2
hyp3_2 <- glm(urine_color_split ~ income_split + household_size + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location, data = clean_data_wide, family = "binomial")
summary(hyp3_2)
confint(hyp3_2, level=0.95)

hyp3_2_tb <- tbl_regression(hyp3_2, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                            label = 
                              c(income_split ~ "Income",
                                household_size ~ "Household size",
                                color_blind ~ "Colour blind",
                                medication ~ "Medication",
                                menstruation ~ "Menstruating",
                                pregnant_lactating ~ "Pregnant/lactating",
                                high_protein_caloric ~ "High protein or caloric diet"))  %>% 
  bold_p(t = 0.05)

# step 3
hyp3_3 <- glm(urine_color_split ~ income_split + household_size + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location + age_cent + gender + BMI_cent + MET_PA_cent, data = clean_data_wide, family = "binomial")
summary(hyp3_3)
confint(hyp3_3, level=0.95)

hyp3_3_tb <- tbl_regression(hyp3_3, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                            label = 
                              c(income_split ~ "Income",
                                household_size ~ "Household size",
                                color_blind ~ "Colour blind",
                                medication ~ "Medication",
                                menstruation ~ "Menstruating",
                                pregnant_lactating ~ "Pregnant/lactating",
                                high_protein_caloric ~ "High protein or caloric diet",
                                age_cent ~ "Age", 
                                gender ~ "Gender", 
                                BMI_cent ~ "BMI (kg/m2)", 
                                MET_PA_cent ~ "Physical activity (MET/day)"))  %>% 
  bold_p(t = 0.05)

tbl_merge_ex6 <-
  tbl_merge(
    tbls = list(hyp3_1_tb, hyp3_2_tb, hyp3_3_tb),
    tab_spanner = c("**Step 1**", "**Step 2**", "**Step 3**")
  )
```
```{r}
tbl_merge_ex6
```
```{r}
# Convert to gt object
gt_tbl <- as_gt(tbl_merge_ex6)

# Write to Word
gtsave(gt_tbl, "tbl_merge_ex6.docx")

# descriptives
clean_data_wide %>% 
  group_by(income_split) %>% 
  select(urine_color_split) %>% 
  dplyr::count(urine_color_split == "adequate") %>%
  dplyr::mutate(percent = n/sum(n))
```

## SES and fluid intake

```{r}
clean_data_wide %>% 
  dplyr::group_by(education_split) %>% 
  dplyr::summarize(mean = mean(total_fluid_extra),
            sd = sd(total_fluid_extra), 
            mean_water = mean(total_water),
            sd_water = sd(total_water), 
            mean_ssb = mean(total_ssb),
            sd_ssb = sd(total_ssb))

# total intake
hyp3_1 <- lm(total_fluid_extra ~ education_split, data = clean_data_wide)
summary(hyp3_1, confint = TRUE)
confint(hyp3_1, level=0.95)

# water intake
hyp3_1 <- lm(total_water ~ education_split, data = clean_data_wide)
summary(hyp3_1)
confint(hyp3_1, level=0.95)

# ssb intake
hyp3_1 <- lm(total_ssb ~ education_split, data = clean_data_wide)
summary(hyp3_1)
confint(hyp3_1, level=0.95)

## with education as categorical
# total intake
hyp3_1 <- lm(total_fluid_extra ~ education_cat, data = clean_data_wide)
summary(hyp3_1, confint = TRUE)
confint(hyp3_1, level=0.95)

# water intake
hyp3_1 <- lm(total_water ~ education_cat, data = clean_data_wide)
summary(hyp3_1)
confint(hyp3_1, level=0.95)

# ssb intake
hyp3_1 <- lm(total_ssb ~ education_cat, data = clean_data_wide)
summary(hyp3_1)
confint(hyp3_1, level=0.95)

# descriptivess
clean_data_wide %>% 
  group_by(education_cat) %>% 
  select(urine_color_split) %>% 
  dplyr::count(urine_color_split == "adequate") %>%
  dplyr::mutate(percent = n/sum(n))
```

### Without "no formal education"

```{r}
clean_data_wide_edu <- clean_data_wide %>% 
  dplyr::filter(education_cat != "No formal qualifications") %>% 
  droplevels()

# total intake
hyp3_1 <- lm(total_fluid_extra ~ education_cat, data = clean_data_wide_edu)
summary(hyp3_1)

# water intake
hyp3_1 <- lm(total_water~ education_cat, data = clean_data_wide_edu, family = "binomial")
summary(hyp3_1)
confint(hyp3_1, level=0.95)

# ssb intake
hyp3_1 <- lm(total_ssb~ education_cat, data = clean_data_wide_edu, family = "binomial")
summary(hyp3_1)
confint(hyp3_1, level=0.95)
```

### With income
```{r}
clean_data_wide %>% 
  dplyr::group_by(income_split) %>% 
  dplyr::summarize(mean = mean(total_fluid_extra),
            sd = sd(total_fluid_extra), 
            mean_water = mean(total_water),
            sd_water = sd(total_water), 
            mean_ssb = mean(total_ssb),
            sd_ssb = sd(total_ssb))

# total intake
hyp3_1 <- lm(total_fluid_extra ~ income_split, data = clean_data_wide)
summary(hyp3_1, confint = TRUE)
confint(hyp3_1, level=0.95)

# water intake
hyp3_1 <- lm(total_water ~ income_split, data = clean_data_wide)
summary(hyp3_1)
confint(hyp3_1, level=0.95)

# ssb intake
hyp3_1 <- lm(total_ssb ~ income_split, data = clean_data_wide)
summary(hyp3_1)
confint(hyp3_1, level=0.95)
```

## Correlations
```{r}
# Whether water intake, SSB intake, and hydration status correlate with beverage (water and SSB) liking. 

# water liking
plot <- geom_plot(clean_data_wide, water_liking, "water_liking")
plot

intake_matrix <- clean_data_wide %>% 
  select(c(water_liking, total_water, total_ssb, urine_color_r, void_frequency)) %>% 
  as.matrix()

intake_matrix <- clean_data_wide %>% 
  select(c(water_liking, total_water, total_ssb, urine_color_r, void_frequency)) 

#cor(intake_matrix, use = "pairwise.complete.obs")

# Calculate the correlation matrix with p-values
correlation_matrix <- rcorr(as.matrix(intake_matrix))

# print the correlation matrix
print(correlation_matrix$r)

# print the p-values
print(correlation_matrix$P)

# ssb liking
plot <- geom_plot(clean_data_wide, ssb_liking, "ssb_liking")
plot

intake_matrix <- clean_data_wide %>% 
  select(c(ssb_liking, total_water, total_ssb, urine_color_r, void_frequency)) %>% 
  as.matrix()

# Calculate the correlation matrix with p-values
correlation_matrix <- rcorr(as.matrix(intake_matrix))

# print the correlation matrix
print(correlation_matrix$r)

# print the p-values
print(correlation_matrix$P)

# needs Spearman
cor.test(clean_data_wide$ssb_liking, clean_data_wide$urine_color_r, method="spearman")

# needs Spearman
cor.test(clean_data_wide$ssb_liking, clean_data_wide$void_frequency, method="spearman")

cor.test(clean_data_wide$total_ssb, clean_data_wide$total_water)

plot(clean_data_wide$total_ssb, clean_data_wide$total_water)

# association between water and ssb liking
cor.test(clean_data_wide$ssb_liking, clean_data_wide$water_liking)
```

## Open answers
```{r}
# proportions who already knew or did not know color chart
prop.table(table(clean_data_open$chart_prior))*100

# if 1, 2 and 3 are in their answers, they have the question correct
prop.table(table(clean_data_open$urine_color_health))*100

# we coded their open responses
open_coded <- "Final_coding.csv"
headers = read_csv(open_coded, col_names = FALSE, n_max = 1) %>%
  as.character()
open_coded = read_csv(open_coded, skip = 4, col_names = FALSE)
colnames(open_coded)= headers

open_coded <- open_coded %>% 
  select(-c("color_drink", "color_health", "color_own")) #remove open responses

# merge
merged_open <- merge(clean_data_wide, open_coded, by = "response_id", all.x = TRUE)

merged_open <- merged_open %>% 
  select(response_id, education_cat, education_split, urine_color_split, color_drink_coded_1, color_drink_coded_2, color_drink_coded_3, color_health_coded_1, color_health_coded_2, color_health_coded_3, Color_own_coded_1, Color_own_coded_2, Color_own_coded_3)
```

# Additional analyses

## Descriptives for paper
```{r}
# percentage hydrated for low vs. high education
clean_data_wide %>%
  group_by(education_split) %>%
  summarise(
    n = n(),
    n_adequate = sum(urine_color_split == "adequate", na.rm = TRUE),
    pct_adequate = n_adequate / n * 100
  )

clean_data_wide %>%
  filter(income_split %in% c("low (<40.000)","high (>40.000)")) %>%
  group_by(income_split) %>%
  summarise(
    n = n(),
    n_adequate = sum(urine_color_split == "adequate", na.rm = TRUE),
    pct_adequate = n_adequate / n * 100
  )

# amount consumed
clean_data_wide %>% 
  dplyr::group_by(education_split) %>% 
  dplyr::summarize(mean = mean(total_fluid_extra),
            sd = sd(total_fluid_extra), 
            mean_water = mean(total_water),
            sd_water = sd(total_water), 
            mean_ssb = mean(total_ssb),
            sd_ssb = sd(total_ssb))

# correlation between income and education
cor.test(clean_data_wide$education, clean_data_wide$income)
```

## Linear models
```{r}
# H1
hyp1_1 <- lm(urine_color_r ~ total_water_cent, data = clean_data_wide)
summary(hyp1_1)
confint(hyp1_1)

# H2
hyp2_1 <- lm(urine_color_r ~ total_ssb_cent, data = clean_data_wide)
summary(hyp2_1)
confint(hyp2_1)

# H3
hyp3_1 <- lm(urine_color_r ~ education_split, data = clean_data_wide)
summary(hyp3_1)
confint(hyp3_1)
```

## H1-H3 using void frequency
```{r}
## Logistic 
# step 1
hyp1_1 <- glm(void_frequency_split ~ total_water_cent, data = clean_data_wide, family = "binomial")
summary(hyp1_1)

hyp1_1_tb <- tbl_regression(hyp1_1, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            label = 
                              c(total_water_cent ~ "Total water intake")) %>% 
                              bold_p(t = 0.05)

# step 2: control vars separately 0/1 for each control factor
hyp1_2 <- glm(void_frequency_split ~ total_water_cent + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric, data = clean_data_wide, family = "binomial")
summary(hyp1_2)

hyp1_2_tb <- tbl_regression(hyp1_2, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(total_water_cent ~ "Total water intake",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet"))  %>% 
                              bold_p(t = 0.05)

# step 3
hyp1_3 <- glm(void_frequency_split ~ total_water_cent + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + age_cent + gender + BMI_cent + MET_PA_cent, data = clean_data_wide, family = "binomial")
summary(hyp1_3)

#multicolinearity: as a rule of thumb, a VIF value that exceeds 5 or 10 indicates a problematic amount of collinearity (https://quantifyinghealth.com/vif-threshold/)
check_collinearity(hyp1_3)

hyp1_3_tb <- tbl_regression(hyp1_3, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(total_water_cent ~ "Total water intake",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet",
                               age_cent ~ "Age", 
                               gender ~ "Gender", 
                               BMI_cent ~ "BMI (kg/m2)", 
                               MET_PA_cent ~ "Physical activity (MET/day)"))  %>% 
                              bold_p(t = 0.05)

tbl_merge_ex7 <-
  tbl_merge(
    tbls = list(hyp1_1_tb, hyp1_2_tb, hyp1_3_tb),
    tab_spanner = c("**Step 1**", "**Step 2**", "**Step 3**")
  )
```
```{r}
tbl_merge_ex7
```
```{r}
# Convert to gt object
gt_tbl <- as_gt(tbl_merge_ex7)

# Write to Word
gtsave(gt_tbl, "tbl_merge_ex7.docx")
```

Hypothesis 2: SSB intake will be negatively associated with hydration status (lighter urine colour). 

```{r}
## Logistic
# step 1
hyp2_1 <- glm(void_frequency_split ~ total_ssb_cent, data = clean_data_wide, family = "binomial")
summary(hyp2_1)

# diagnostics look great
dat.sim <- simulateResiduals(hyp2_1, 1000)
plot(dat.sim) #residuals look good (linearity test with transformed log to "normal" residuals)
testDispersion(hyp2_1) 
testUniformity(dat.sim)
testOutliers(dat.sim, plot = T) #no influential observations

hyp2_1_tb <- tbl_regression(hyp2_1, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            label = 
                              c(total_ssb_cent ~ "Total SSB intake"))  %>% 
                              bold_p(t = 0.05)
  

# step 2: control vars separately 0/1 for each control factor
hyp2_2 <- glm(void_frequency_split ~ total_ssb_cent + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric, data = clean_data_wide, family = "binomial")
summary(hyp2_2)

hyp2_2_tb <- tbl_regression(hyp2_2, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(total_ssb_cent ~ "Total SSB intake",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet"))  %>% 
                              bold_p(t = 0.05)

# step 3
hyp2_3 <- glm(void_frequency_split ~ total_ssb_cent + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + age_cent + gender + BMI_cent + MET_PA_cent, data = clean_data_wide, family = "binomial")
summary(hyp2_3)

#multicolinearity: as a rule of thumb, a VIF value that exceeds 5 or 10 indicates a problematic amount of collinearity (https://quantifyinghealth.com/vif-threshold/)
check_collinearity(hyp2_3)

hyp2_3_tb <- tbl_regression(hyp2_3, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(total_ssb_cent ~ "Total SSB intake",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet",
                               age_cent ~ "Age", 
                               gender ~ "Gender", 
                               BMI_cent ~ "BMI (kg/m2)", 
                               MET_PA_cent ~ "Physical activity (MET/day)"))  %>% 
                              bold_p(t = 0.05)

tbl_merge_ex8 <-
  tbl_merge(
    tbls = list(hyp2_1_tb, hyp2_2_tb, hyp2_3_tb),
    tab_spanner = c("**Step 1**", "**Step 2**", "**Step 3**")
  )
```
```{r}
tbl_merge_ex8
```
```{r}
# Convert to gt object
gt_tbl <- as_gt(tbl_merge_ex8)

# Write to Word
gtsave(gt_tbl, "tbl_merge_ex8.docx")
```

```{r}
# step 1
hyp3_1 <- glm(void_frequency_split ~ education_split, data = clean_data_wide, family = "binomial")
summary(hyp3_1)

# diagnostics look <3
dat.sim <- simulateResiduals(hyp3_1, 1000)
plot(dat.sim) #residuals look good (linearity test with transformed log to "normal" residuals)
testDispersion(hyp3_1) 
testUniformity(dat.sim)
testOutliers(dat.sim, plot = T) #no influential observations

hyp3_1_tb <- tbl_regression(hyp3_1, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            label = 
                              c(education_split ~ "Education"))  %>% 
                              bold_p(t = 0.05)

# step 2
hyp3_2 <- glm(void_frequency_split ~ education_split + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location, data = clean_data_wide, family = "binomial")
summary(hyp3_2)

hyp3_2_tb <- tbl_regression(hyp3_2, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(education_split ~ "Education",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet"))  %>% 
                              bold_p(t = 0.05)

# step 3
hyp3_3 <- glm(void_frequency_split ~ education_split + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location + age_cent + gender + BMI_cent + MET_PA_cent, data = clean_data_wide, family = "binomial")
summary(hyp3_3)

hyp3_3_tb <- tbl_regression(hyp3_3, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(education_split ~ "Education",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet",
                               age_cent ~ "Age", 
                               gender ~ "Gender", 
                               BMI_cent ~ "BMI (kg/m2)", 
                               MET_PA_cent ~ "Physical activity (MET/day)"))  %>% 
                              bold_p(t = 0.05)


tbl_merge_ex9 <-
  tbl_merge(
    tbls = list(hyp3_1_tb, hyp3_2_tb, hyp3_3_tb),
    tab_spanner = c("**Step 1**", "**Step 2**", "**Step 3**")
  )
```
```{r}
tbl_merge_ex9

# Convert to gt object
gt_tbl <- as_gt(tbl_merge_ex9)

# Write to Word
gtsave(gt_tbl, "tbl_merge_ex9.docx")
```

## H1-H3 with only Day 1 of data collection
### H1
```{r}
range(clean_data_wide$day)

# step 1
hyp1_1 <- glm(urine_color_split ~ total_water_cent, data = subset(clean_data_wide, day %in% 7), family = "binomial")
summary(hyp1_1)

hyp1_1_tb <- tbl_regression(hyp1_1, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            label = 
                              c(total_water_cent ~ "Total water intake")) %>% 
                              bold_p(t = 0.05)

# step 2: control vars separately 0/1 for each control factor
hyp1_2_hyp <- glm(urine_color_split ~ total_water_cent + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + location, data = subset(clean_data_wide, day %in% 7), family = "binomial")
summary(hyp1_2_hyp)

hyp1_2_tb <- tbl_regression(hyp1_2, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(total_water_cent ~ "Total water intake",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet")) %>% 
                               bold_p(t = 0.05)

# step 3
hyp1_3 <- glm(urine_color_split ~ total_water_cent + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + location + age_cent + gender + BMI_cent + MET_PA_cent, data = subset(clean_data_wide, day %in% 7), family = "binomial")
summary(hyp1_3)

hyp1_3_tb <- tbl_regression(hyp1_3, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(total_water_cent ~ "Total water intake",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet",
                               age_cent ~ "Age", 
                               gender ~ "Gender", 
                               BMI_cent ~ "BMI (kg/m2)", 
                               MET_PA_cent ~ "Physical activity (MET/day)"))  %>% 
                               bold_p(t = 0.05)

tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(hyp1_1_tb, hyp1_2_tb, hyp1_3_tb),
    tab_spanner = c("**Step 1**", "**Step 2**", "**Step 3**")
  )
```
```{r}
tbl_merge_ex2
```

### H2
```{r}
# step 1
hyp2_1 <- glm(urine_color_split ~ total_ssb_cent, data = subset(clean_data_wide, day %in% 7), family = "binomial")
summary(hyp2_1)

hyp2_1_tb <- tbl_regression(hyp2_1, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            label = 
                              c(total_ssb_cent ~ "Total SSB intake"))  %>% 
                              bold_p(t = 0.05)


# step 2: control vars separately 0/1 for each control factor
hyp2_2 <- glm(urine_color_split ~ total_ssb_cent + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric, data = subset(clean_data_wide, day %in% 7), family = "binomial")
summary(hyp2_2)

hyp2_2_tb <- tbl_regression(hyp2_2, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(total_ssb_cent ~ "Total SSB intake",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet"))  %>% 
                              bold_p(t = 0.05)

# step 3
hyp2_3 <- glm(urine_color_split ~ total_ssb_cent + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location + age_cent + gender + BMI_cent + MET_PA_cent, data = subset(clean_data_wide, day %in% 7), family = "binomial")
summary(hyp2_3)

hyp2_3_tb <- tbl_regression(hyp2_3, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(total_ssb_cent ~ "Total SSB intake",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet",
                               age_cent ~ "Age", 
                               gender ~ "Gender", 
                               BMI_cent ~ "BMI (kg/m2)", 
                               MET_PA_cent ~ "Physical activity (MET/day)"))  %>% 
                              bold_p(t = 0.05)

tbl_merge_ex3 <-
  tbl_merge(
    tbls = list(hyp2_1_tb, hyp2_2_tb, hyp2_3_tb),
    tab_spanner = c("**Step 1**", "**Step 2**", "**Step 3**")
  )
```
```{r}
tbl_merge_ex3
```

### H3
```{r}
# step 1
hyp3_1 <- glm(urine_color_split ~ education_split, data = subset(clean_data_wide, day %in% 7), family = "binomial")
summary(hyp3_1)

hyp3_1_tb <- tbl_regression(hyp3_1, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            label = 
                              c(education_split ~ "Education"))  %>% 
                              bold_p(t = 0.05)

# step 2
hyp3_2 <- glm(urine_color_split ~ education_split + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location, data = subset(clean_data_wide, day %in% 7), family = "binomial")
summary(hyp3_2)

hyp3_2_tb <- tbl_regression(hyp3_2, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(education_split ~ "Education",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet"))  %>% 
                              bold_p(t = 0.05)

# step 3
hyp3_3 <- glm(urine_color_split ~ education_split + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location + age_cent + gender + BMI_cent + MET_PA_cent, data = subset(clean_data_wide, day %in% 7), family = "binomial")
summary(hyp3_3)

hyp3_3_tb <- tbl_regression(hyp3_3, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(education_split ~ "Education",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet",
                               age_cent ~ "Age", 
                               gender ~ "Gender", 
                               BMI_cent ~ "BMI (kg/m2)", 
                               MET_PA_cent ~ "Physical activity (MET/day)"))  %>% 
                              bold_p(t = 0.05)

tbl_merge_ex4 <-
  tbl_merge(
    tbls = list(hyp3_1_tb, hyp3_2_tb, hyp3_3_tb),
    tab_spanner = c("**Step 1**", "**Step 2**", "**Step 3**")
  )
```
```{r}
tbl_merge_ex4
```


## H1-H3 with only participants who are 80% confident about their urine colour
### H1
```{r}
# step 1
hyp1_1 <- glm(urine_color_split ~ total_water_cent, data = subset(clean_data_wide, color_confidence_1 >= 80), family = "binomial")
summary(hyp1_1)

hyp1_1_tb <- tbl_regression(hyp1_1, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            label = 
                              c(total_water_cent ~ "Total water intake")) %>% 
                              bold_p(t = 0.05)

# step 2: control vars separately 0/1 for each control factor
hyp1_2_hyp <- glm(urine_color_split ~ total_water_cent + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location, data = subset(clean_data_wide, color_confidence_1 >= 80), family = "binomial")
summary(hyp1_2_hyp)

hyp1_2_tb <- tbl_regression(hyp1_2, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(total_water_cent ~ "Total water intake",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet")) %>% 
                               bold_p(t = 0.05)

# step 3
hyp1_3 <- glm(urine_color_split ~ total_water_cent + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location + age_cent + gender + BMI_cent + MET_PA_cent, data = subset(clean_data_wide, color_confidence_1 >= 80), family = "binomial")
summary(hyp1_3)

hyp1_3_tb <- tbl_regression(hyp1_3, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(total_water_cent ~ "Total water intake",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet",
                               age_cent ~ "Age", 
                               gender ~ "Gender", 
                               BMI_cent ~ "BMI (kg/m2)", 
                               MET_PA_cent ~ "Physical activity (MET/day)"))  %>% 
                               bold_p(t = 0.05)

tbl_merge_ex2 <-
  tbl_merge(
    tbls = list(hyp1_1_tb, hyp1_2_tb, hyp1_3_tb),
    tab_spanner = c("**Step 1**", "**Step 2**", "**Step 3**")
  )
```
```{r}
tbl_merge_ex2
```

### H2
```{r}
# step 1
hyp2_1 <- glm(urine_color_split ~ total_ssb_cent, data = subset(clean_data_wide, color_confidence_1 >= 80), family = "binomial")
summary(hyp2_1)

hyp2_1_tb <- tbl_regression(hyp2_1, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            label = 
                              c(total_ssb_cent ~ "Total SSB intake"))  %>% 
                              bold_p(t = 0.05)


# step 2: control vars separately 0/1 for each control factor
hyp2_2 <- glm(urine_color_split ~ total_ssb_cent + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location, data = subset(clean_data_wide, color_confidence_1 >= 80), family = "binomial")
summary(hyp2_2)

hyp2_2_tb <- tbl_regression(hyp2_2, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(total_ssb_cent ~ "Total SSB intake",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet"))  %>% 
                              bold_p(t = 0.05)

# step 3
hyp2_3 <- glm(urine_color_split ~ total_ssb_cent + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location + age_cent + gender + BMI_cent + MET_PA_cent, data = subset(clean_data_wide, color_confidence_1 >= 80), family = "binomial")
summary(hyp2_3)

hyp2_3_tb <- tbl_regression(hyp2_3, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(total_ssb_cent ~ "Total SSB intake",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet",
                               age_cent ~ "Age", 
                               gender ~ "Gender", 
                               BMI_cent ~ "BMI (kg/m2)", 
                               MET_PA_cent ~ "Physical activity (MET/day)"))  %>% 
                              bold_p(t = 0.05)

tbl_merge_ex3 <-
  tbl_merge(
    tbls = list(hyp2_1_tb, hyp2_2_tb, hyp2_3_tb),
    tab_spanner = c("**Step 1**", "**Step 2**", "**Step 3**")
  )
```
```{r}
tbl_merge_ex3
```

### H3
```{r}
# step 1
hyp3_1 <- glm(urine_color_split ~ education_split, data = subset(clean_data_wide, color_confidence_1 >= 80), family = "binomial")
summary(hyp3_1)

hyp3_1_tb <- tbl_regression(hyp3_1, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            label = 
                              c(education_split ~ "Education"))  %>% 
                              bold_p(t = 0.05)

# step 2
hyp3_2 <- glm(urine_color_split ~ education_split + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location, data = subset(clean_data_wide, color_confidence_1 >= 80), family = "binomial")
summary(hyp3_2)

hyp3_2_tb <- tbl_regression(hyp3_2, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(education_split ~ "Education",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet"))  %>% 
                              bold_p(t = 0.05)

# step 3
hyp3_3 <- glm(urine_color_split ~ education_split + color_blind + medication + menstruation + pregnant_lactating + high_protein_caloric + day + location + age_cent + gender + BMI_cent + MET_PA_cent, data = subset(clean_data_wide, color_confidence_1 >= 80), family = "binomial")
summary(hyp3_3)

hyp3_3_tb <- tbl_regression(hyp3_3, 
                            exponentiate = TRUE,
                            pvalue_fun = purrr::partial(style_sigfig, digits = 3),
                            show_single_row = c(color_blind, medication,
                                                menstruation, pregnant_lactating, high_protein_caloric),
                           label = 
                              c(education_split ~ "Education",
                               color_blind ~ "Colour blind",
                               medication ~ "Medication",
                               menstruation ~ "Menstruating",
                               pregnant_lactating ~ "Pregnant/lactating",
                               high_protein_caloric ~ "High protein or caloric diet",
                               age_cent ~ "Age", 
                               gender ~ "Gender", 
                               BMI_cent ~ "BMI (kg/m2)", 
                               MET_PA_cent ~ "Physical activity (MET/day)"))  %>% 
                              bold_p(t = 0.05)

tbl_merge_ex4 <-
  tbl_merge(
    tbls = list(hyp3_1_tb, hyp3_2_tb, hyp3_3_tb),
    tab_spanner = c("**Step 1**", "**Step 2**", "**Step 3**")
  )
```
```{r}
tbl_merge_ex4
```

## Correlation between SSB and other fluids
```{r}
ggplot(clean_data_wide, aes(x = total_ssb, y = total_water)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_cor(p.accuracy = 0.001, r.accuracy = 0.001)

# correlation with water intake
cor.test(clean_data_wide$total_ssb, clean_data_wide$total_water, method="spearman")

# correlation with other fluids
cor.test(clean_data_wide$total_ssb, clean_data_wide$other_fluids_except_ssb_cent, method="spearman")

ggplot(clean_data_wide, aes(x = total_ssb, y = other_fluids_except_ssb_cent)) +
  geom_point() +
  geom_smooth(method = "lm") +
  stat_cor(p.accuracy = 0.001, r.accuracy = 0.001)

# analysis for low vs. high fluid intakes
median(clean_data_wide$other_fluids_except_ssb)

clean_data_wide <- clean_data_wide %>% 
  mutate(total_fluid_cat = case_when(other_fluids_except_ssb <= 2225 ~ "low",
                                     other_fluids_except_ssb > 2225 ~ "high"))

table(clean_data_wide$total_fluid_cat)

# low drinkers
hyp2_1 <- glm(urine_color_split ~ total_ssb_cent, data = subset(clean_data_wide, total_fluid_cat %in% "low"), family = "binomial")
summary(hyp2_1)

# high drinkers
hyp2_1 <- glm(urine_color_split ~ total_ssb_cent, data = subset(clean_data_wide, total_fluid_cat %in% "high"), family = "binomial")
summary(hyp2_1)
```



## Assessing H1 and H2 in each SES category separately

### H1
#### No formal qualifications
```{r}
hyp1_1 <- glm(urine_color_split ~ total_water_cent, data = subset(clean_data_wide, education_cat == "No formal qualifications"), family = "binomial")
summary(hyp1_1)
confint(hyp1_1)
```

#### Secondary education
```{r}
hyp1_1 <- glm(urine_color_split ~ total_water_cent, data = subset(clean_data_wide, education_cat == "Secondary education"), family = "binomial")
summary(hyp1_1)
confint(hyp1_1)
```

#### High school diploma/A-levels
```{r}
hyp1_1 <- glm(urine_color_split ~ total_water_cent, data = subset(clean_data_wide, education_cat == "High school diploma/A-levels"), family = "binomial")
summary(hyp1_1)
confint(hyp1_1)
```

#### Technical/community college
```{r}
hyp1_1 <- glm(urine_color_split ~ total_water_cent, data = subset(clean_data_wide, education_cat == "Technical/community college"), family = "binomial")
summary(hyp1_1)
confint(hyp1_1)
```

#### Undergraduate degree
```{r}
hyp1_1 <- glm(urine_color_split ~ total_water_cent, data = subset(clean_data_wide, education_cat == "Undergraduate degree"), family = "binomial")
summary(hyp1_1)
confint(hyp1_1)
```

#### Graduate/Doctorate degree
```{r}
hyp1_1 <- glm(urine_color_split ~ total_water_cent, data = subset(clean_data_wide, education_cat == "Graduate/Doctorate degree"), family = "binomial")
summary(hyp1_1)
confint(hyp1_1)
```

### H2
#### No formal qualifications
```{r}
hyp2_1 <- glm(urine_color_split ~ total_ssb_cent, data = subset(clean_data_wide, education_cat == "No formal qualifications"), family = "binomial")
summary(hyp2_1)
confint(hyp2_1)
```

#### Secondary education
```{r}
hyp2_1 <- glm(urine_color_split ~ total_ssb_cent, data = subset(clean_data_wide, education_cat == "Secondary education"), family = "binomial")
summary(hyp2_1)
confint(hyp2_1)
```

#### High school diploma/A-levels
```{r}
hyp2_1 <- glm(urine_color_split ~ total_ssb_cent, data = subset(clean_data_wide, education_cat == "High school diploma/A-levels"), family = "binomial")
summary(hyp2_1)
confint(hyp2_1)
```

#### Technical/community college
```{r}
hyp2_1 <- glm(urine_color_split ~ total_ssb_cent, data = subset(clean_data_wide, education_cat == "Technical/community college"), family = "binomial")
summary(hyp2_1)
confint(hyp2_1)
```

#### Undergraduate degree
```{r}
hyp2_1 <- glm(urine_color_split ~ total_ssb_cent, data = subset(clean_data_wide, education_cat == "Undergraduate degree"), family = "binomial")
summary(hyp2_1)
confint(hyp2_1)
```

#### Graduate/Doctorate degree
```{r}
hyp2_1 <- glm(urine_color_split ~ total_ssb_cent, data = subset(clean_data_wide, education_cat == "Graduate/Doctorate degree"), family = "binomial")
summary(hyp2_1)
confint(hyp2_1)
```


```{r}
knitr::knit_exit()
```